---
description: FastAPI/Web 코딩 표준
globs: "web/**/*.py"
alwaysApply: false
---

# FastAPI 코딩 표준

## 디렉토리 구조

```
web/
├── __main__.py           # 진입점
├── app.py                # FastAPI 앱 (라우터 등록)
├── config.py             # Web 설정
├── dependencies.py       # 의존성 주입 (get_db, get_current_user)
│
├── routes/               # API 라우트 (기능별 분리)
│   ├── __init__.py
│   ├── dashboard.py      # GET /api/dashboard
│   ├── events.py         # GET /api/events
│   ├── commands.py       # GET/POST /api/commands
│   ├── config.py         # GET/PUT /api/config
│   └── health.py         # GET /health
│
├── models/               # Pydantic 스키마
│   ├── __init__.py
│   ├── schemas.py        # Request/Response 모델
│   └── responses.py      # 공통 응답 모델
│
└── services/             # 비즈니스 로직 (선택)
    ├── __init__.py
    └── *.py
```

## 라우터 규칙

### APIRouter 사용

```python
# ✅ GOOD - 파일별 라우터 생성
from fastapi import APIRouter

router = APIRouter(prefix="/api", tags=["dashboard"])

@router.get("/dashboard", response_model=DashboardResponse)
async def get_dashboard(...):
    ...

# ❌ BAD - app에 직접 데코레이터
@app.get("/api/dashboard")
async def get_dashboard(...):
    ...
```

### app.py에서 라우터 등록

```python
# web/app.py
from fastapi import FastAPI
from web.routes import dashboard, events, commands, config, health

app = FastAPI(
    title="AlphaEngine API",
    version="2.0.0",
    docs_url="/docs",
    redoc_url="/redoc",
)

app.include_router(dashboard.router)
app.include_router(events.router)
app.include_router(commands.router)
app.include_router(config.router)
app.include_router(health.router)
```

## 엔드포인트 규칙

### response_model 필수

```python
# ✅ GOOD - response_model 명시
@router.get("/dashboard", response_model=DashboardResponse)
async def get_dashboard(...) -> DashboardResponse:
    ...

# ❌ BAD - response_model 생략
@router.get("/dashboard")
async def get_dashboard(...):
    return {"position": ...}
```

### 상태 코드 명시

```python
# ✅ GOOD - 적절한 상태 코드
@router.post("/commands", response_model=CommandResponse, status_code=201)
async def create_command(...):
    ...

@router.delete("/commands/{id}", status_code=204)
async def delete_command(...):
    return None
```

### Path 파라미터 타입

```python
from uuid import UUID

# ✅ GOOD - UUID 타입 명시
@router.get("/commands/{command_id}")
async def get_command(command_id: UUID, ...):
    ...

# ❌ BAD - str 타입
@router.get("/commands/{command_id}")
async def get_command(command_id: str, ...):
    ...
```

## 의존성 주입 (Depends)

### 표준 의존성

```python
# dependencies.py

async def get_db() -> AsyncGenerator[AsyncSession, None]:
    """DB 세션"""
    async with async_session() as session:
        yield session

async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: AsyncSession = Depends(get_db),
) -> User:
    """JWT 인증된 사용자"""
    ...

async def get_settings() -> Settings:
    """애플리케이션 설정"""
    ...
```

### 엔드포인트에서 사용

```python
# ✅ GOOD - Depends 사용
@router.post("/commands", response_model=CommandResponse)
async def create_command(
    request: CommandCreateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    ...

# ❌ BAD - 직접 세션 생성
@router.post("/commands")
async def create_command(request: CommandCreateRequest):
    async with async_session() as db:
        ...
```

## Pydantic 스키마 규칙

### 네이밍 규칙

| 용도 | 패턴 | 예시 |
|------|------|------|
| 요청 | `{Resource}{Action}Request` | `CommandCreateRequest`, `ConfigUpdateRequest` |
| 응답 | `{Resource}Response` | `CommandResponse`, `DashboardResponse` |
| 목록 응답 | `{Resource}ListResponse` | `EventListResponse` |
| 상세 응답 | `{Resource}DetailResponse` | `CommandDetailResponse` |

### 스키마 정의

```python
# models/schemas.py
from pydantic import BaseModel, Field
from datetime import datetime
from uuid import UUID

class CommandCreateRequest(BaseModel):
    """Command 생성 요청"""
    type: str = Field(..., description="Command 타입")
    payload: dict = Field(default_factory=dict)
    idempotency_key: str | None = Field(None, description="멱등성 키")
    
    model_config = {"frozen": True}

class CommandResponse(BaseModel):
    """Command 응답"""
    command_id: UUID
    status: str
    message: str | None = None
```

## 에러 처리

### HTTPException 사용

```python
from fastapi import HTTPException

# ✅ GOOD - 적절한 상태 코드와 메시지
if not command:
    raise HTTPException(status_code=404, detail="Command not found")

if config.version != expected_version:
    raise HTTPException(
        status_code=409,
        detail=f"Version conflict: expected {expected_version}, got {config.version}"
    )

# ❌ BAD - 500 에러로 처리
if not command:
    raise Exception("Command not found")
```

### 에러 응답 형식 통일

```python
# models/responses.py
class ErrorResponse(BaseModel):
    """에러 응답"""
    detail: str
    code: str | None = None  # 선택: 에러 코드
```

## 인증/인가

### 인증 필요 엔드포인트

```python
# 쓰기 작업 (POST, PUT, DELETE) → 인증 필수
@router.post("/commands", response_model=CommandResponse)
async def create_command(
    request: CommandCreateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),  # 인증 필수
):
    ...

# 읽기 작업 (GET) → 인증 선택적 (설정에 따라)
@router.get("/dashboard", response_model=DashboardResponse)
async def get_dashboard(
    db: AsyncSession = Depends(get_db),
    # 인증 없이 조회 가능 (또는 선택적 인증)
):
    ...
```

### 인증 방식

| 환경 | 방식 | 용도 |
|------|------|------|
| 개발 | 비활성화 또는 기본값 | 편의성 |
| 운영 | JWT | 사용자 인증 |
| Bot 통신 | API Key (X-API-Key 헤더) | 서비스 간 통신 |

## DB 접근 규칙

Web은 **읽기 위주**, 쓰기는 Command 삽입만:

| 테이블 | 허용 작업 |
|--------|----------|
| event_store | READ only |
| command_store | READ + INSERT (UPDATE 불가) |
| config_store | READ + UPDATE |
| projection_* | READ only |

```python
# ✅ GOOD - Command INSERT만
db.add(command)
await db.commit()

# ❌ BAD - Event 직접 생성 (Bot 역할)
event = Event(...)
db.add(event)
```

## 로깅

```python
import logging

logger = logging.getLogger(__name__)

@router.post("/commands", response_model=CommandResponse)
async def create_command(
    request: CommandCreateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    logger.info(
        "Command 생성",
        extra={
            "command_type": request.type,
            "user": current_user.username,
        }
    )
    ...
```

## 테스트

```python
# tests/integration/web/test_commands.py
from fastapi.testclient import TestClient
from web.app import app

client = TestClient(app)

def test_create_command_returns_201():
    response = client.post(
        "/api/commands",
        json={"type": "PlaceOrder", "payload": {...}},
        headers={"Authorization": "Bearer test_token"},
    )
    assert response.status_code == 201
    assert "command_id" in response.json()

def test_get_command_not_found_returns_404():
    response = client.get("/api/commands/00000000-0000-0000-0000-000000000000")
    assert response.status_code == 404
```
