{% extends "base.html" %}

{% block title %}입출금 - AlphaEngine{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-3 mb-md-4"><i class="bi bi-arrow-left-right"></i> 입출금 관리</h2>
    </div>
</div>

<!-- 진행 중인 이체 알림 -->
<div id="pending-alert" class="alert alert-info d-none" role="alert">
    <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        <span id="pending-message">이체가 진행 중입니다...</span>
        <button class="btn btn-sm btn-outline-primary ms-auto" onclick="viewTransferDetail()">상세보기</button>
    </div>
</div>

<div class="row g-2 g-md-3">
    <!-- 입금 카드 -->
    <div class="col-12 col-md-6 mb-2 mb-md-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-box-arrow-in-down"></i> <span class="d-none d-sm-inline">입금 (Upbit → Binance)</span><span class="d-sm-none">입금</span></h5>
            </div>
            <div class="card-body">
                <div id="deposit-status" class="mb-3">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <form id="deposit-form" class="d-none">
                    <div class="mb-3">
                        <label class="form-label">입금 금액 (KRW)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="deposit-amount" 
                                   min="5000" step="1000" placeholder="최소 5,000원">
                            <span class="input-group-text">원</span>
                        </div>
                        <div class="btn-group w-100 mt-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDepositPercent(25)">25%</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDepositPercent(50)">50%</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDepositPercent(75)">75%</button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="setDepositPercent(100)">최대</button>
                        </div>
                        <div class="form-text">수수료 약 1 TRX (≈ 150원) 발생</div>
                    </div>
                    <button type="submit" class="btn btn-success w-100" id="deposit-btn">
                        <i class="bi bi-check-circle"></i> 입금 시작
                    </button>
                </form>
                
                <div id="deposit-unavailable" class="text-center text-muted d-none">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                    <p class="mt-2" id="deposit-unavailable-msg">입금 불가</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 출금 카드 -->
    <div class="col-12 col-md-6 mb-2 mb-md-4">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-box-arrow-up"></i> <span class="d-none d-sm-inline">출금 (Binance → Upbit)</span><span class="d-sm-none">출금</span></h5>
            </div>
            <div class="card-body">
                <div id="withdraw-status" class="mb-3">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <form id="withdraw-form" class="d-none">
                    <div class="mb-3">
                        <label class="form-label">출금 금액 (USDT)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="withdraw-amount" 
                                   min="10" step="1" placeholder="최소 10 USDT">
                            <span class="input-group-text">USDT</span>
                        </div>
                        <div class="btn-group w-100 mt-2" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setWithdrawPercent(25)">25%</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setWithdrawPercent(50)">50%</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setWithdrawPercent(75)">75%</button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="setWithdrawPercent(100)">최대</button>
                        </div>
                        <div class="form-text">수수료 약 1 TRX 발생</div>
                    </div>
                    <div id="position-warning" class="alert alert-warning d-none mb-3">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <span id="position-warning-msg"></span>
                    </div>
                    <button type="submit" class="btn btn-danger w-100" id="withdraw-btn">
                        <i class="bi bi-check-circle"></i> 출금 시작
                    </button>
                </form>
                
                <div id="withdraw-unavailable" class="text-center text-muted d-none">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                    <p class="mt-2" id="withdraw-unavailable-msg">출금 불가</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 이체 진행 상태 -->
<div class="row" id="progress-section" style="display: none;">
    <div class="col-12 mb-3 mb-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-hourglass-split"></i> 이체 진행</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span id="progress-type" class="badge bg-primary">입금</span>
                    <span id="progress-status" class="badge bg-info">진행중</span>
                </div>
                <div class="progress mb-3" style="height: 20px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%;">0%</div>
                </div>
                <div class="row text-center g-2">
                    <div class="col-4">
                        <small class="text-muted d-block" style="font-size: 0.7rem;">요청 금액</small>
                        <div id="progress-amount" class="fw-bold small">-</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block" style="font-size: 0.7rem;">현재 단계</small>
                        <div id="progress-step" class="fw-bold small">0 / 6</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block" style="font-size: 0.7rem;">이체 ID</small>
                        <div id="progress-id" class="fw-bold small text-truncate">-</div>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <button class="btn btn-sm btn-outline-danger" id="cancel-btn" onclick="cancelTransfer()">
                        <i class="bi bi-x-circle"></i> 취소
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 이체 내역 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> 이체 내역</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory()">
                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="d-none d-md-table-cell">ID</th>
                                <th>유형</th>
                                <th class="text-end">요청</th>
                                <th class="text-end d-none d-sm-table-cell">실제</th>
                                <th>상태</th>
                                <th class="d-none d-lg-table-cell">요청 시각</th>
                                <th class="d-none d-md-table-cell">완료</th>
                            </tr>
                        </thead>
                        <tbody id="history-table">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    로딩 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 상세 모달 -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">이체 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detail-content">
                <!-- 동적 내용 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-warning d-none" id="retry-btn" onclick="retryTransfer()">
                    <i class="bi bi-arrow-repeat"></i> 재시도
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/transfer.js"></script>
<script>
    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        loadDepositStatus();
        loadWithdrawStatus();
        loadHistory();
        checkPendingTransfers();
        
        // 10초마다 상태 갱신
        setInterval(function() {
            checkPendingTransfers();
        }, 10000);
    });
</script>
{% endblock %}
