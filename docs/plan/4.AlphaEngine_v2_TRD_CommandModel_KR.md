# AlphaEngine v2 TRD --- Command Model (Hybrid + Bot/Web 아키텍처)

생성일: 2026-02-20

본 문서는 AlphaEngine v2의 **Command(명령) 모델**을 TRD 수준으로 확정한다.

------------------------------------------------------------------------

## 0. 설계 원칙

1. **Bot/Strategy/Web/System**은 **Command만 발행**한다 (DB 직접 수정 금지, config_store 제외).
2. Command는 항상 **idempotent**해야 한다 (중복 실행에도 결과 동일).
3. **Bot만 거래소 호출**을 수행한다 (Web은 Command 발행만).
4. Command 실행 결과는 반드시 Event로 남는다 (성공/실패/거부 포함).
5. 신규 주문은 항상 `client_order_id`를 포함하며, **command_id 기반으로 결정적으로 생성**한다.
6. **Web에서 발행한 Command도 Bot이 처리**한다.

------------------------------------------------------------------------

# 1. 공통 Command Envelope

모든 Command는 아래 필드를 가진다.

```json
{
  "command_id": "uuid",
  "type": "PlaceOrder",
  "ts": "2026-02-20T00:00:00Z",
  "correlation_id": "uuid",
  "causation_id": "uuid-or-null",
  "actor": {
    "kind": "STRATEGY|USER|SYSTEM",
    "id": "strategy:xxx|user:admin|system:reconciler|web:dashboard"
  },
  "scope": {
    "exchange": "BINANCE",
    "venue": "FUTURES|SPOT",
    "account_id": "acc-001",
    "symbol": "XRPUSDT",
    "mode": "PRODUCTION|TESTNET"
  },
  "idempotency_key": "string",
  "payload": {},
  "priority": 0
}
```

### 필드 규칙

| 필드 | 설명 |
|------|------|
| `command_id` | UUID (발행자가 생성) |
| `correlation_id` | 하나의 업무 흐름을 묶는 ID |
| `idempotency_key` | 기본은 `command_id`, 외부 시스템 키로 대체 가능 |
| `scope.venue` | SPOT/FUTURES 지정 |
| `scope.mode` | PRODUCTION/TESTNET (v2 신규) |
| `actor.id` | 발행자 식별 (전략명, 사용자ID, 시스템명 등) |
| `priority` | 우선순위 (0=기본, 높을수록 먼저 처리) (v2 신규) |

------------------------------------------------------------------------

# 2. Command Type 목록 (v2)

## 2.1 Engine / Control

| Command Type | 발행자 | 목적 | 주요 payload |
|--------------|--------|------|--------------|
| PauseEngine | WEB/BOT | 전략/자동 실행 일시 정지 | reason |
| ResumeEngine | WEB/BOT | 재개 | reason |
| SetEngineMode | WEB/BOT | 엔진 모드 변경 | mode (RUNNING/SAFE/PAUSED), reason |
| CancelAll | WEB/BOT | 모든 오픈오더 취소 | include_venue, reason |
| RunReconcile | WEB/BOT | 즉시 리컨실 실행 | from_ts, to_ts (optional) |
| RebuildProjection | WEB/BOT | 프로젝션 재생성 | from_event_id (optional) |
| UpdateConfig | WEB | 설정 변경 (v2 신규) | key, value, version |

------------------------------------------------------------------------

## 2.2 Trading (공통, venue로 구분)

| Command Type | 발행자 | 목적 | 주요 payload |
|--------------|--------|------|--------------|
| PlaceOrder | STRATEGY/WEB | 주문 생성 | client_order_id, side, order_type, qty, price, stop_price, reduce_only |
| CancelOrder | STRATEGY/WEB | 단일 주문 취소 | client_order_id 또는 exchange_order_id |
| ClosePosition | WEB/STRATEGY | 포지션 청산 | venue=FUTURES, mode(MARKET), reason |
| SetLeverage | WEB/BOT | 레버리지 설정 (v2 신규) | leverage, symbol |

------------------------------------------------------------------------

## 2.3 Transfers (Futures ↔ Spot)

| Command Type | 발행자 | 목적 | 주요 payload |
|--------------|--------|------|--------------|
| InternalTransfer | BOT/WEB | 지갑간 내부이체 | from_wallet, to_wallet, asset, amount |

------------------------------------------------------------------------

## 2.4 External Withdrawals (Spot → 외부)

| Command Type | 발행자 | 목적 | 주요 payload |
|--------------|--------|------|--------------|
| Withdraw | BOT/WEB | 외부 출금 요청 | asset, amount, address, network, memo |

------------------------------------------------------------------------

# 3. PlaceOrder payload 상세

```json
{
  "client_order_id": "ae-<command_id>",
  "side": "BUY|SELL",
  "position_side": "LONG|SHORT|BOTH",
  "order_type": "MARKET|LIMIT|STOP_MARKET|TAKE_PROFIT_MARKET|STOP|TAKE_PROFIT",
  "qty": "12.345",
  "price": "0.5123",
  "stop_price": "0.4980",
  "reduce_only": true,
  "time_in_force": "GTC|IOC|FOK",
  "tags": {
    "intent": "ENTRY|EXIT|SL|TP",
    "strategy_id": "sma_cross_v1"
  }
}
```

### 규칙

- `client_order_id`는 **결정적으로 생성**: `ae-<command_id>` 규칙
- 타임아웃 발생 시 **즉시 재주문 금지** (조회→결정 프로토콜)
- `reduce_only`는 청산/보호 주문에 기본 적용

------------------------------------------------------------------------

# 4. Idempotency & Timeout 프로토콜

## 4.1 Idempotency 기본 규칙

- 모든 Command는 `command_id`로 유일하다.
- `command_store`는 `command_id` UNIQUE를 가진다.
- 거래소 주문은 `client_order_id` UNIQUE로 매핑한다.
- `idempotency_key` UNIQUE INDEX로 재발행 방지.

## 4.2 PlaceOrder 타임아웃 처리

PlaceOrder 요청이 타임아웃/5xx 등으로 "결과를 모르는 상태"가 되면:

1. 동일 `client_order_id`로 **주문 존재 여부 조회**
2. 존재하면 → 주문 생성 성공으로 간주, `OrderPlaced` 이벤트
3. 존재하지 않으면 → 제한된 재시도 수행 (정책에 따라 1~N회)
4. 최종 실패 시 → `OrderRejected` 또는 `DriftDetected` 이벤트

> 핵심 목표: **중복 주문 0**

------------------------------------------------------------------------

# 5. Command 발행 흐름

## 5.1 Bot 내부 발행 (Strategy → Executor)

```
┌──────────┐    Command    ┌──────────┐    ┌──────────┐
│ Strategy │ ────────────→ │ Command  │ ───│ Executor │
│          │               │ Store    │    │          │
└──────────┘               └──────────┘    └──────────┘
     │                          │                │
     │ on_tick()                │ INSERT         │ claim_new()
     │ emit(PlaceOrder)         │ status=NEW     │ process_one()
     │                          │                │ status=ACK/FAILED
```

## 5.2 Web → Bot 발행 (Command Queue)

```
┌──────────┐    INSERT     ┌──────────┐    ┌──────────┐
│   Web    │ ────────────→ │ Command  │ ←──│   Bot    │
│ (FastAPI)│  status=NEW   │ Store    │    │(폴링/처리)│
└──────────┘               └──────────┘    └──────────┘
     │                          │                │
     │ POST /api/commands       │                │ claim_new()
     │ CancelAll, etc.          │                │ process_one()
     │                          │                │ status=ACK
```

### Web Command 발행 규칙

1. Web은 `command_store`에 INSERT만 수행
2. `status = NEW`, `actor.kind = USER`, `actor.id = web:{user_id}`
3. Bot이 주기적으로 NEW 상태 Command 조회 (claim)
4. Bot이 Command 처리 후 status 업데이트
5. Web은 status 폴링하여 결과 확인

------------------------------------------------------------------------

# 6. Command ↔ Event 매핑

| Command | 기대 Event (최소) |
|---------|-------------------|
| PauseEngine | EnginePaused |
| ResumeEngine | EngineResumed |
| SetEngineMode | EngineModeChanged |
| CancelAll | OrderCancelled (0..N) + ManualOverrideExecuted |
| PlaceOrder | OrderPlaced 또는 OrderRejected |
| CancelOrder | OrderCancelled 또는 OrderUpdated |
| ClosePosition | TradeExecuted (1..N) + PositionChanged |
| SetLeverage | ConfigChanged (또는 LeverageChanged) |
| InternalTransfer | InternalTransferRequested + Completed/Failed |
| Withdraw | WithdrawRequested + Completed/Failed |
| RunReconcile | ReconciliationPerformed |
| RebuildProjection | (운영 로그) |
| UpdateConfig | ConfigChanged |

------------------------------------------------------------------------

# 7. 저장소 요구사항

## 7.1 command_store (SQLite)

```sql
CREATE TABLE command_store (
  seq              INTEGER PRIMARY KEY AUTOINCREMENT,
  command_id       TEXT NOT NULL UNIQUE,
  ts               TEXT NOT NULL,
  type             TEXT NOT NULL,
  correlation_id   TEXT NOT NULL,
  causation_id     TEXT,
  
  actor_kind       TEXT NOT NULL,
  actor_id         TEXT NOT NULL,
  
  scope_exchange   TEXT NOT NULL,
  scope_venue      TEXT NOT NULL,
  scope_account_id TEXT NOT NULL,
  scope_symbol     TEXT,
  scope_mode       TEXT NOT NULL DEFAULT 'PRODUCTION',
  
  idempotency_key  TEXT NOT NULL,
  status           TEXT NOT NULL,
  priority         INTEGER NOT NULL DEFAULT 0,
  last_error       TEXT,
  payload_json     TEXT NOT NULL,
  
  created_at       TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at       TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE UNIQUE INDEX ux_command_store_idempotency_key
ON command_store(idempotency_key);

CREATE INDEX ix_command_store_status_priority_ts
ON command_store(status, priority DESC, ts);

CREATE INDEX ix_command_store_correlation
ON command_store(correlation_id);
```

## 7.2 command_to_exchange (SQLite)

```sql
CREATE TABLE command_to_exchange (
  command_id        TEXT NOT NULL UNIQUE REFERENCES command_store(command_id),
  client_order_id   TEXT NOT NULL UNIQUE,
  exchange_order_id TEXT,
  last_checked_ts   TEXT,
  metadata_json     TEXT,
  
  created_at        TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at        TEXT NOT NULL DEFAULT (datetime('now'))
);
```

------------------------------------------------------------------------

# 8. Command 상태 전이

```
          ┌──────────┐
          │   NEW    │  (발행됨, 미처리)
          └────┬─────┘
               │ claim_new()
               ↓
          ┌──────────┐
          │   SENT   │  (처리 시작)
          └────┬─────┘
               │
      ┌────────┴────────┐
      ↓                 ↓
┌──────────┐      ┌──────────┐
│   ACK    │      │  FAILED  │
│ (성공)   │      │  (실패)  │
└──────────┘      └──────────┘
```

### 상태 전이 규칙

- `NEW → SENT`: Bot이 claim할 때
- `SENT → ACK`: 성공 (거래소 응답 또는 Reconcile 확인)
- `SENT → FAILED`: 실패 (거래소 거절 또는 정책 재시도 종료)
- `FAILED`에서 재시도 시: 새 command_id로 재발행 (기존 재사용 금지)

------------------------------------------------------------------------

# 9. Web API (Command 발행)

## 9.1 엔드포인트

```
POST /api/commands
Content-Type: application/json

{
  "type": "CancelAll",
  "scope": {
    "exchange": "BINANCE",
    "venue": "FUTURES",
    "account_id": "acc-001",
    "symbol": "XRPUSDT"
  },
  "payload": {
    "reason": "user_requested"
  },
  "idempotency_key": "user:admin:cancel_all:2026-02-20T12:00"
}
```

## 9.2 응답

```json
{
  "command_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "NEW",
  "message": "Command accepted"
}
```

## 9.3 상태 조회

```
GET /api/commands/{command_id}

{
  "command_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "ACK",
  "result": {
    "orders_cancelled": 3
  }
}
```

------------------------------------------------------------------------

# 10. Priority 규칙 (v2 신규)

| Priority | 발행자 | 설명 |
|----------|--------|------|
| 100 | WEB (긴급) | 사용자 긴급 청산, CancelAll |
| 50 | WEB (일반) | 사용자 일반 명령 |
| 10 | SYSTEM | 시스템 자동 명령 (Reconcile 등) |
| 0 | STRATEGY | 전략 자동 명령 |

Bot은 `claim_new()` 시 priority DESC 순으로 처리.

------------------------------------------------------------------------

문서 종료
