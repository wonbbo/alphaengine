# AlphaEngine v2 TRD --- State Machines

생성일: 2026-02-20

본 문서는 AlphaEngine v2의 상태머신을 TRD 수준으로 고정한다.

------------------------------------------------------------------------

# 1. OrderState

주문의 생명주기를 추적한다.

```
┌─────────┐
│   NEW   │  Command 생성됨 (로컬)
└────┬────┘
     │ API 호출
     ↓
┌──────────┐
│SUBMITTED │  거래소로 전송됨
└────┬─────┘
     │
     ├──────────────────────────────────┐
     ↓                                  ↓
┌────────────┐                    ┌──────────┐
│ACKNOWLEDGED│  거래소가 인지    │  FAILED  │  전송 실패 (미확정)
└─────┬──────┘                    └────┬─────┘
      │                                │
      ├─────────────┐                  │ 조회→결정으로
      │             │                  │ ACKNOWLEDGED/REJECTED로 수렴
      ↓             ↓                  │
┌──────────────┐ ┌──────────┐          │
│PARTIALLY_    │ │ CANCELLED│          │
│FILLED        │ │          │          │
└──────┬───────┘ └──────────┘          │
       │                               │
       ↓                               │
┌──────────┐   ┌──────────┐           │
│  FILLED  │   │ REJECTED │←──────────┘
│ (완전체결)│   │ (거절)   │
└──────────┘   └──────────┘
       │
       ↓
┌──────────┐
│ EXPIRED  │  (시간 만료)
└──────────┘
```

### 상태 설명

| 상태 | 의미 | 다음 상태 |
|------|------|-----------|
| NEW | Command 생성됨 (로컬) | SUBMITTED |
| SUBMITTED | 거래소로 전송됨 | ACKNOWLEDGED / FAILED |
| ACKNOWLEDGED | 거래소가 주문 인지 | PARTIALLY_FILLED / FILLED / CANCELLED / REJECTED |
| PARTIALLY_FILLED | 일부 체결 | FILLED / CANCELLED |
| FILLED | 완전 체결 | (종료) |
| CANCELLED | 취소 완료 | (종료) |
| REJECTED | 거래소 거절 | (종료) |
| EXPIRED | 시간 만료 | (종료) |
| FAILED | 전송 실패 (미확정) | 조회→결정으로 ACKNOWLEDGED/REJECTED로 수렴 |

### WebSocket 연동

- `ORDER_TRADE_UPDATE` 메시지의 `X` 필드가 상태
- 실시간으로 상태 전이 감지

------------------------------------------------------------------------

# 2. PositionState (FUTURES)

포지션의 생명주기를 추적한다.

```
┌─────────┐
│  FLAT   │  포지션 없음
└────┬────┘
     │ TradeExecuted (qty > 0)
     ↓
┌──────────┐
│ ENTERING │  진입 진행 중
└────┬─────┘
     │ qty 확정
     ↓
┌──────────┐
│   OPEN   │  포지션 보유
└────┬─────┘
     │ 청산 주문 / 체결
     ↓
┌──────────┐
│ EXITING  │  청산 진행 중
└────┬─────┘
     │ qty = 0
     ↓
┌─────────┐
│  FLAT   │
└─────────┘
```

### 상태 설명

| 상태 | 의미 | 전이 조건 |
|------|------|-----------|
| FLAT | 포지션 없음 | TradeExecuted로 qty > 0 → ENTERING |
| ENTERING | 진입 진행 | qty 확정 시 → OPEN |
| OPEN | 포지션 보유 | 청산 주문/체결 → EXITING |
| EXITING | 청산 진행 | qty = 0 수렴 시 → FLAT |

### 단순화 옵션

실제 구현에서는 ENTERING/EXITING을 생략하고 FLAT/OPEN만 사용해도 됨:

```
FLAT ←→ OPEN
```

------------------------------------------------------------------------

# 3. CommandState

Command의 처리 상태를 추적한다.

```
┌─────────┐
│   NEW   │  생성됨, 미전송
└────┬────┘
     │ claim_new()
     ↓
┌─────────┐
│  SENT   │  전송 시도됨
└────┬────┘
     │
     ├────────────────┐
     ↓                ↓
┌─────────┐     ┌─────────┐
│   ACK   │     │ FAILED  │
│ (확정)  │     │ (실패)  │
└─────────┘     └─────────┘
```

### 상태 설명

| 상태 | 의미 |
|------|------|
| NEW | 생성됨, 미전송 |
| SENT | 전송 시도됨 (처리 중) |
| ACK | 확정 이벤트로 수렴 (성공/거절 포함) |
| FAILED | 실패로 종결 (정책상 재시도 종료) |

### 재시도 규칙

- FAILED에서 재시도 시: 새 command_id로 재발행
- 기존 command_id 재사용 금지

------------------------------------------------------------------------

# 4. TransferState (InternalTransfer)

내부 이체의 상태를 추적한다.

```
┌───────────┐
│ REQUESTED │  내부이체 요청 생성
└─────┬─────┘
      │
      ├──────────────┐
      ↓              ↓
┌───────────┐  ┌──────────┐
│ COMPLETED │  │  FAILED  │
│ (완료)    │  │  (실패)  │
└───────────┘  └──────────┘
```

### 상태 설명

| 상태 | 의미 |
|------|------|
| REQUESTED | 내부이체 요청 생성 |
| COMPLETED | 거래소 기준 완료 |
| FAILED | 실패 (사유 포함) |

------------------------------------------------------------------------

# 5. WithdrawState

출금의 상태를 추적한다.

```
┌───────────┐
│ REQUESTED │  출금 요청 생성
└─────┬─────┘
      │
      ├──────────────┬──────────────┐
      ↓              ↓              ↓
┌───────────┐  ┌───────────┐  ┌──────────┐
│ PROCESSING│  │ COMPLETED │  │  FAILED  │
│ (처리중)  │  │ (완료)    │  │  (실패)  │
└─────┬─────┘  └───────────┘  └──────────┘
      │
      ├──────────────┐
      ↓              ↓
┌───────────┐  ┌──────────┐
│ COMPLETED │  │  FAILED  │
└───────────┘  └──────────┘
```

### 상태 설명

| 상태 | 의미 |
|------|------|
| REQUESTED | 출금 요청 생성 |
| PROCESSING | 거래소에서 처리 중 |
| COMPLETED | 출금 완료 |
| FAILED | 출금 실패 |

------------------------------------------------------------------------

# 6. EngineState

엔진의 운영 상태를 추적한다.

```
┌──────────┐
│ BOOTING  │  시작 중
└────┬─────┘
     │ 초기화 완료
     ↓
┌──────────┐ ←─────────────────────────────┐
│ RUNNING  │  정상 운영                    │
└────┬─────┘                               │
     │                                     │
     ├──────────────┐                      │
     ↓              ↓                      │
┌──────────┐  ┌──────────┐                │
│  PAUSED  │  │   SAFE   │                │
│ (일시정지)│  │ (안전모드)│                │
└────┬─────┘  └────┬─────┘                │
     │              │                      │
     └──────────────┴──────────────────────┘
           ResumeEngine
```

### 상태 설명

| 상태 | 의미 | 허용 동작 |
|------|------|-----------|
| BOOTING | 시작 중 | 초기화만 |
| RUNNING | 정상 운영 | 모든 동작 |
| PAUSED | 일시정지 | 모니터링만 (전략 비활성) |
| SAFE | 안전 모드 | 취소/청산만 (신규 진입 차단) |

### 전이 규칙

- BOOTING → RUNNING: 초기화 완료 시 자동
- RUNNING → PAUSED: PauseEngine Command
- PAUSED → RUNNING: ResumeEngine Command
- RUNNING → SAFE: 리스크 위반 또는 SetEngineMode Command
- SAFE → RUNNING: SetEngineMode Command (수동)

------------------------------------------------------------------------

# 7. WebSocketState (v2 신규)

WebSocket 연결 상태를 추적한다.

```
┌──────────────┐
│ DISCONNECTED │  연결 없음
└──────┬───────┘
       │ connect()
       ↓
┌──────────────┐
│  CONNECTING  │  연결 시도 중
└──────┬───────┘
       │
       ├──────────────────────┐
       ↓                      ↓
┌──────────────┐        ┌──────────────┐
│  CONNECTED   │        │ DISCONNECTED │
│  (연결됨)    │        │  (실패)      │
└──────┬───────┘        └──────────────┘
       │
       │ 연결 끊김
       ↓
┌──────────────┐
│ RECONNECTING │  재연결 시도 중
└──────┬───────┘
       │
       ├──────────────┐
       ↓              ↓
┌──────────────┐ ┌──────────────┐
│  CONNECTED   │ │ DISCONNECTED │
│  (재연결)    │ │  (재시도 중) │
└──────────────┘ └──────────────┘
```

### 상태 설명

| 상태 | 의미 | REST Polling |
|------|------|--------------|
| DISCONNECTED | 연결 없음 | 활성 (짧은 간격) |
| CONNECTING | 연결 시도 중 | 활성 |
| CONNECTED | 연결됨 | 비활성 또는 긴 간격 |
| RECONNECTING | 재연결 시도 중 | 활성 (짧은 간격) |

### 재연결 정책

- 연결 끊김 감지 시 즉시 RECONNECTING
- 지수 백오프: 1초 → 2초 → 4초 → 8초 → 최대 30초
- 재연결 성공 시 CONNECTED + REST로 누락 이벤트 수집

------------------------------------------------------------------------

# 8. ReconcileState (v2 신규)

Reconciler의 동작 상태를 추적한다.

```
┌──────────┐
│   IDLE   │  대기 중
└────┬─────┘
     │ tick / trigger
     ↓
┌──────────┐
│ RUNNING  │  정합 수행 중
└────┬─────┘
     │
     ├──────────────┐
     ↓              ↓
┌──────────┐  ┌──────────┐
│ COMPLETE │  │  ERROR   │
│ (완료)   │  │  (오류)  │
└────┬─────┘  └────┬─────┘
     │              │
     └──────────────┘
           ↓
     ┌──────────┐
     │   IDLE   │
     └──────────┘
```

### 상태 설명

| 상태 | 의미 |
|------|------|
| IDLE | 대기 중 (다음 tick 대기) |
| RUNNING | 정합 수행 중 |
| COMPLETE | 정상 완료 |
| ERROR | 오류 발생 (로그 후 IDLE로 복귀) |

------------------------------------------------------------------------

# 9. ConfigState (v2 신규)

설정의 버전 상태를 추적한다.

```
┌──────────┐
│  ACTIVE  │  현재 적용 중
└────┬─────┘
     │ UpdateConfig
     ↓
┌──────────┐
│ PENDING  │  변경 대기 (Web에서 수정됨)
└────┬─────┘
     │ Bot이 감지 & 적용
     ↓
┌──────────┐
│  ACTIVE  │  새 버전 적용
└──────────┘
```

### 설정 적용 흐름

1. Web이 config_store 업데이트 (version 증가)
2. Bot이 주기적으로 config_store 조회
3. 버전 변경 감지 시 ConfigChanged 이벤트
4. 새 설정 적용

------------------------------------------------------------------------

문서 종료
