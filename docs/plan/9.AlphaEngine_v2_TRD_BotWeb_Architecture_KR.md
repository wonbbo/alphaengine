# AlphaEngine v2 TRD --- Bot/Web Architecture

생성일: 2026-02-20

본 문서는 AlphaEngine v2의 Bot과 Web 분리 아키텍처를 TRD 수준으로 고정한다.

------------------------------------------------------------------------

# 1. 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Linux Server                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                        nginx                                   │  │
│  │               (HTTPS termination, reverse proxy)               │  │
│  └───────────────────────────┬───────────────────────────────────┘  │
│                              │                                       │
│                              │ HTTP/WS                               │
│                              ↓                                       │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                     Web Process                                │  │
│  │              (alphaengine-web.service)                        │  │
│  │                                                                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │  │
│  │  │  Dashboard  │  │   Config    │  │  Command    │           │  │
│  │  │    API      │  │    API      │  │    API      │           │  │
│  │  │   (READ)    │  │ (READ/WRITE)│  │   (WRITE)   │           │  │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘           │  │
│  │         │                │                │                    │  │
│  │         └────────────────┼────────────────┘                    │  │
│  │                          │                                      │  │
│  │                   FastAPI + uvicorn                             │  │
│  └──────────────────────────┼────────────────────────────────────┘  │
│                              │                                       │
│                              │ TCP/IP (PostgreSQL Protocol)          │
│                              │                                       │
│  ┌───────────────────────────┴───────────────────────────────────┐  │
│  │                      PostgreSQL                                │  │
│  │                                                                │  │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ │  │
│  │  │event_store │ │command_    │ │projection_ │ │config_     │ │  │
│  │  │            │ │store       │ │*           │ │store       │ │  │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘ │  │
│  │                                                                │  │
│  └───────────────────────────┬───────────────────────────────────┘  │
│                              │                                       │
│                              │ TCP/IP                                │
│                              │                                       │
│  ┌───────────────────────────┴───────────────────────────────────┐  │
│  │                      Bot Process                               │  │
│  │               (alphaengine-bot.service)                       │  │
│  │                                                                │  │
│  │  ┌─────────────────────────────────────────────────────────┐  │  │
│  │  │                    Main Loop                             │  │  │
│  │  │                                                          │  │  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │  │  │
│  │  │  │WebSocket │  │Reconciler│  │ Command  │              │  │  │
│  │  │  │ Listener │  │  (REST)  │  │ Claimer  │              │  │  │
│  │  │  └────┬─────┘  └────┬─────┘  └────┬─────┘              │  │  │
│  │  │       │             │             │                     │  │  │
│  │  │       └──────┬──────┴──────┬──────┘                     │  │  │
│  │  │              ↓             ↓                            │  │  │
│  │  │        ┌──────────┐  ┌──────────┐                      │  │  │
│  │  │        │  Event   │  │ Command  │                      │  │  │
│  │  │        │  Store   │  │  Store   │                      │  │  │
│  │  │        └────┬─────┘  └────┬─────┘                      │  │  │
│  │  │             │             │                             │  │  │
│  │  │             └──────┬──────┘                             │  │  │
│  │  │                    ↓                                    │  │  │
│  │  │              ┌──────────┐                               │  │  │
│  │  │              │Projector │                               │  │  │
│  │  │              └────┬─────┘                               │  │  │
│  │  │                   ↓                                     │  │  │
│  │  │              ┌──────────┐  ┌──────────┐                │  │  │
│  │  │              │ Strategy │→ │ Executor │                │  │  │
│  │  │              │  Runner  │  │          │                │  │  │
│  │  │              └──────────┘  └────┬─────┘                │  │  │
│  │  │                                 │                       │  │  │
│  │  │                                 ↓                       │  │  │
│  │  │                          Binance API                    │  │  │
│  │  │                                                          │  │  │
│  │  └──────────────────────────────────────────────────────────┘  │  │
│  │                                                                │  │
│  └────────────────────────────────────────────────────────────────┘  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

------------------------------------------------------------------------

# 2. Bot Process

## 2.1 책임

| 컴포넌트 | 책임 |
|----------|------|
| WebSocket Listener | 실시간 이벤트 수신 |
| REST Reconciler | 정합 보장, 누락 이벤트 수집 |
| Command Claimer | NEW 상태 Command 조회 및 처리 |
| Event Store Writer | 이벤트 저장 |
| Projector | 이벤트 → Projection 반영 |
| Strategy Runner | 전략 실행, Command 생성 |
| Executor | 거래소 API 호출 |

## 2.2 Main Loop

```python
async def main_loop():
    """Bot 메인 루프"""
    
    # 초기화
    db = await connect_db()
    ws_listener = BinanceWebSocketListener(...)
    reconciler = Reconciler(...)
    projector = Projector(...)
    strategy_runner = StrategyRunner(...)
    executor = Executor(...)
    command_claimer = CommandClaimer(...)
    
    # WebSocket 시작
    await ws_listener.start()
    
    # 초기 Reconcile
    await reconciler.full_reconcile()
    
    # 메인 루프
    while True:
        try:
            # 1. 새 이벤트 → Projection 반영
            await projector.apply_pending_events()
            
            # 2. Web에서 발행한 Command 처리
            command = await command_claimer.claim_one()
            if command:
                await process_command(command, executor)
            
            # 3. 전략 실행 (현재 상태 기반)
            ctx = await build_strategy_context(projector)
            new_commands = await strategy_runner.on_tick(ctx)
            
            # 4. 전략 Command 처리
            for cmd in new_commands:
                await command_store.insert(cmd)
                await process_command(cmd, executor)
            
            # 5. Reconcile (주기적)
            if should_reconcile():
                await reconciler.tick()
            
            # 6. Config 변경 감지
            await check_config_changes()
            
            await asyncio.sleep(0.1)  # tick 간격
            
        except Exception as e:
            logger.error(f"Main loop error: {e}")
            await asyncio.sleep(1)
```

## 2.3 Command 처리 흐름

```python
async def process_command(command: Command, executor: Executor) -> None:
    """Command 처리"""
    try:
        # 상태 업데이트: SENT
        await command_store.update_status(command.command_id, "SENT")
        
        # 명령 타입별 처리
        if command.type == "PlaceOrder":
            result = await executor.place_order(command.payload)
        elif command.type == "CancelOrder":
            result = await executor.cancel_order(command.payload)
        elif command.type == "ClosePosition":
            result = await executor.close_position(command.payload)
        # ... 기타 명령
        
        # 상태 업데이트: ACK
        await command_store.update_status(
            command.command_id, "ACK", result=result
        )
        
    except Exception as e:
        # 상태 업데이트: FAILED
        await command_store.update_status(
            command.command_id, "FAILED", error=str(e)
        )
```

------------------------------------------------------------------------

# 3. Web Process

## 3.1 책임

| 컴포넌트 | 책임 |
|----------|------|
| Dashboard API | 현재 상태 조회 (읽기 전용) |
| Events API | 이벤트 히스토리 조회 |
| Commands API | Command 발행 및 상태 조회 |
| Config API | 설정 조회 및 수정 |

## 3.2 FastAPI 구조

```
web/
├── __main__.py           # 진입점
├── app.py                # FastAPI 앱
├── config.py             # 설정
├── dependencies.py       # 의존성 주입
│
├── routes/
│   ├── __init__.py
│   ├── dashboard.py      # GET /api/dashboard
│   ├── events.py         # GET /api/events
│   ├── commands.py       # GET/POST /api/commands
│   ├── config.py         # GET/PUT /api/config
│   └── health.py         # GET /health
│
├── models/
│   ├── __init__.py
│   ├── schemas.py        # Pydantic 스키마
│   └── responses.py      # 응답 모델
│
└── services/
    ├── __init__.py
    ├── event_service.py
    ├── command_service.py
    └── config_service.py
```

## 3.3 API 엔드포인트

### Dashboard

```python
# routes/dashboard.py

@router.get("/api/dashboard", response_model=DashboardResponse)
async def get_dashboard(db: AsyncSession = Depends(get_db)):
    """현재 상태 대시보드"""
    
    # 포지션
    position = await db.execute(
        select(ProjectionPosition)
        .where(ProjectionPosition.scope_mode == get_mode())
    )
    
    # 잔고
    balances = await db.execute(
        select(ProjectionBalance)
        .where(ProjectionBalance.scope_mode == get_mode())
    )
    
    # 오픈 주문
    open_orders = await db.execute(
        select(ProjectionOrderOpen)
        .where(ProjectionOrderOpen.status.in_(["NEW", "PARTIALLY_FILLED"]))
    )
    
    # 최근 체결
    recent_trades = await db.execute(
        select(ProjectionTrade)
        .order_by(ProjectionTrade.trade_ts.desc())
        .limit(10)
    )
    
    return DashboardResponse(
        position=position.scalar_one_or_none(),
        balances=balances.scalars().all(),
        open_orders=open_orders.scalars().all(),
        recent_trades=recent_trades.scalars().all(),
    )
```

### Events

```python
# routes/events.py

@router.get("/api/events", response_model=EventListResponse)
async def list_events(
    event_type: str | None = None,
    from_ts: datetime | None = None,
    to_ts: datetime | None = None,
    limit: int = 100,
    offset: int = 0,
    db: AsyncSession = Depends(get_db),
):
    """이벤트 목록 조회"""
    
    query = select(EventStore).order_by(EventStore.seq.desc())
    
    if event_type:
        query = query.where(EventStore.event_type == event_type)
    if from_ts:
        query = query.where(EventStore.ts >= from_ts)
    if to_ts:
        query = query.where(EventStore.ts <= to_ts)
    
    query = query.limit(limit).offset(offset)
    
    result = await db.execute(query)
    return EventListResponse(events=result.scalars().all())
```

### Commands

```python
# routes/commands.py

@router.post("/api/commands", response_model=CommandResponse)
async def create_command(
    request: CommandCreateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """Command 발행"""
    
    command = Command(
        command_id=uuid4(),
        command_type=request.type,
        ts=datetime.utcnow(),
        correlation_id=request.correlation_id or uuid4(),
        actor_kind="USER",
        actor_id=f"web:{current_user.username}",
        scope_exchange=request.scope.exchange,
        scope_venue=request.scope.venue,
        scope_account_id=request.scope.account_id,
        scope_symbol=request.scope.symbol,
        scope_mode=get_mode(),
        idempotency_key=request.idempotency_key or str(uuid4()),
        status="NEW",
        priority=request.priority or 50,  # Web 기본 우선순위
        payload_json=request.payload,
    )
    
    db.add(command)
    await db.commit()
    
    return CommandResponse(
        command_id=command.command_id,
        status=command.status,
        message="Command accepted",
    )

@router.get("/api/commands/{command_id}", response_model=CommandDetailResponse)
async def get_command(
    command_id: UUID,
    db: AsyncSession = Depends(get_db),
):
    """Command 상태 조회"""
    
    result = await db.execute(
        select(CommandStore).where(CommandStore.command_id == command_id)
    )
    command = result.scalar_one_or_none()
    
    if not command:
        raise HTTPException(status_code=404, detail="Command not found")
    
    return CommandDetailResponse(
        command_id=command.command_id,
        type=command.command_type,
        status=command.status,
        result=command.result_json,
        error=command.last_error,
    )
```

### Config

```python
# routes/config.py

@router.get("/api/config/{key}", response_model=ConfigResponse)
async def get_config(
    key: str,
    db: AsyncSession = Depends(get_db),
):
    """설정 조회"""
    
    result = await db.execute(
        select(ConfigStore).where(ConfigStore.key == key)
    )
    config = result.scalar_one_or_none()
    
    if not config:
        raise HTTPException(status_code=404, detail="Config not found")
    
    return ConfigResponse(
        key=config.key,
        value=config.value_json,
        version=config.version,
        updated_at=config.updated_at,
    )

@router.put("/api/config/{key}", response_model=ConfigResponse)
async def update_config(
    key: str,
    request: ConfigUpdateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """설정 수정"""
    
    result = await db.execute(
        select(ConfigStore).where(ConfigStore.key == key)
    )
    config = result.scalar_one_or_none()
    
    if not config:
        raise HTTPException(status_code=404, detail="Config not found")
    
    # 버전 체크 (낙관적 락)
    if request.expected_version and config.version != request.expected_version:
        raise HTTPException(
            status_code=409,
            detail=f"Version conflict: expected {request.expected_version}, got {config.version}",
        )
    
    config.value_json = request.value
    config.version += 1
    config.updated_by = f"web:{current_user.username}"
    config.updated_at = datetime.utcnow()
    
    await db.commit()
    
    # ConfigChanged 이벤트는 Bot이 감지 후 생성
    
    return ConfigResponse(
        key=config.key,
        value=config.value_json,
        version=config.version,
        updated_at=config.updated_at,
    )
```

------------------------------------------------------------------------

# 4. DB 접근 규칙

| 테이블 | Bot | Web |
|--------|-----|-----|
| event_store | READ + APPEND | READ only |
| command_store | READ + UPDATE | READ + INSERT |
| command_to_exchange | READ + WRITE | READ only |
| projection_position | READ + WRITE | READ only |
| projection_balance | READ + WRITE | READ only |
| projection_order_open | READ + WRITE | READ only |
| projection_trade | READ + WRITE | READ only |
| config_store | READ | READ + WRITE |
| checkpoint_store | READ + WRITE | READ only |

------------------------------------------------------------------------

# 5. 통신 패턴

## 5.1 Web → Bot (Command Queue)

```
┌─────┐                  ┌────────────┐                  ┌─────┐
│ Web │                  │ PostgreSQL │                  │ Bot │
└──┬──┘                  └─────┬──────┘                  └──┬──┘
   │                           │                            │
   │ INSERT command            │                            │
   │ (status=NEW)              │                            │
   │ ─────────────────────────→│                            │
   │                           │                            │
   │                           │←───────────────────────────│
   │                           │  SELECT ... WHERE status=NEW
   │                           │  FOR UPDATE SKIP LOCKED    │
   │                           │                            │
   │                           │ UPDATE status=SENT ───────→│
   │                           │                            │
   │                           │        (처리)              │
   │                           │                            │
   │                           │ UPDATE status=ACK ────────→│
   │                           │                            │
   │←──────────────────────────│                            │
   │  GET command/{id}         │                            │
   │  (status 확인)            │                            │
   │                           │                            │
```

## 5.2 Bot → Web (Polling)

Web은 주기적으로 API를 호출하여 상태 확인:

```javascript
// Web Frontend
async function pollDashboard() {
    while (true) {
        const response = await fetch('/api/dashboard');
        const data = await response.json();
        updateUI(data);
        await sleep(1000); // 1초 간격
    }
}
```

## 5.3 실시간 업데이트 (선택 - Server-Sent Events)

```python
# routes/sse.py

@router.get("/api/stream")
async def event_stream(
    db: AsyncSession = Depends(get_db),
):
    """실시간 이벤트 스트림 (SSE)"""
    
    async def generate():
        last_seq = await get_last_seq(db)
        
        while True:
            # 새 이벤트 확인
            new_events = await db.execute(
                select(EventStore)
                .where(EventStore.seq > last_seq)
                .order_by(EventStore.seq)
                .limit(100)
            )
            
            for event in new_events.scalars():
                yield f"data: {event.to_json()}\n\n"
                last_seq = event.seq
            
            await asyncio.sleep(0.5)
    
    return StreamingResponse(
        generate(),
        media_type="text/event-stream",
    )
```

------------------------------------------------------------------------

# 6. 인증/인가

## 6.1 인증 방식

| 환경 | 방식 |
|------|------|
| 개발 | 기본 인증 또는 비활성화 |
| 운영 | JWT + API Key |

## 6.2 JWT 인증

```python
# dependencies.py

from jose import jwt

async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: AsyncSession = Depends(get_db),
) -> User:
    """JWT 토큰으로 현재 사용자 조회"""
    
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        if username is None:
            raise HTTPException(status_code=401)
    except JWTError:
        raise HTTPException(status_code=401)
    
    user = await get_user_by_username(db, username)
    if user is None:
        raise HTTPException(status_code=401)
    
    return user
```

## 6.3 API Key (Bot 통신용 - 선택)

```python
async def verify_api_key(
    x_api_key: str = Header(...),
) -> bool:
    """API Key 검증"""
    
    if x_api_key != settings.API_KEY:
        raise HTTPException(status_code=403)
    
    return True
```

------------------------------------------------------------------------

# 7. 배포 설정

## 7.1 systemd 서비스

### Bot 서비스

```ini
# /etc/systemd/system/alphaengine-bot.service

[Unit]
Description=AlphaEngine Bot
After=network.target

[Service]
Type=simple
User=alphaengine
Group=alphaengine
WorkingDirectory=/opt/alphaengine
ExecStart=/opt/alphaengine/venv/bin/python -m bot
Restart=always
RestartSec=5
StartLimitInterval=60
StartLimitBurst=3

# 로깅
StandardOutput=journal
StandardError=journal
SyslogIdentifier=alphaengine-bot

# 보안
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/alphaengine/data
ReadWritePaths=/opt/alphaengine/logs

[Install]
WantedBy=multi-user.target
```

> 참고: 환경변수 대신 `config/secrets.yaml` 파일에서 설정을 로드합니다.

### Web 서비스

```ini
# /etc/systemd/system/alphaengine-web.service

[Unit]
Description=AlphaEngine Web
After=network.target alphaengine-bot.service

[Service]
Type=simple
User=alphaengine
Group=alphaengine
WorkingDirectory=/opt/alphaengine
ExecStart=/opt/alphaengine/venv/bin/uvicorn web.app:app --host 127.0.0.1 --port 8000
Restart=always
RestartSec=5

# 로깅
StandardOutput=journal
StandardError=journal
SyslogIdentifier=alphaengine-web

# 보안
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/alphaengine/data

[Install]
WantedBy=multi-user.target
```

## 7.2 nginx 설정

```nginx
# /etc/nginx/sites-available/alphaengine

server {
    listen 443 ssl http2;
    server_name alphaengine.example.com;

    ssl_certificate /etc/letsencrypt/live/alphaengine.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/alphaengine.example.com/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SSE 지원
    location /api/stream {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
    }
}
```

## 7.3 운영 명령어

```bash
# 서비스 시작
sudo systemctl start alphaengine-bot
sudo systemctl start alphaengine-web

# 서비스 중지
sudo systemctl stop alphaengine-bot
sudo systemctl stop alphaengine-web

# 상태 확인
sudo systemctl status alphaengine-bot
sudo systemctl status alphaengine-web

# 로그 확인
journalctl -u alphaengine-bot -f
journalctl -u alphaengine-web -f

# 재시작
sudo systemctl restart alphaengine-bot
sudo systemctl restart alphaengine-web
```

------------------------------------------------------------------------

# 8. 설정 관리

AlphaEngine v2는 3단계 설정 관리 방식을 사용한다.

| 분류 | 저장 위치 | 내용 |
|------|----------|------|
| **보안 정보** | secrets.yaml | API Key, Secret, JWT Secret, 모드 선택 |
| **런타임 설정** | DB config_store | 전략, 리스크, 심볼 등 |
| **고정 상수** | 하드코딩 | Binance URL, 기본값 |

## 8.1 secrets.yaml

```yaml
# config/secrets.yaml (git ignore 필수)

# 모드 선택
mode: production  # production | testnet

# Binance API (Production)
production:
  api_key: "xxx"
  api_secret: "xxx"

# Binance API (Testnet)
testnet:
  api_key: "xxx"
  api_secret: "xxx"

# Web
web:
  secret_key: "xxx"  # JWT 서명용
```

## 8.2 DB config_store (런타임 설정)

```json
{
  "trading": {
    "symbol": "XRPUSDT",
    "account_id": "main"
  },
  "strategy": {
    "name": "sma_cross",
    "timeframe": "5m",
    "params": {"fast": 10, "slow": 20}
  },
  "risk": {
    "max_risk_per_trade": 0.02,
    "daily_loss_limit": 0.05
  },
  "logging": {
    "level": "INFO"
  }
}
```

## 8.3 하드코딩 상수 (constants.py)

```python
class BinanceEndpoints:
    PROD_REST_URL = "https://fapi.binance.com"
    PROD_WS_URL = "wss://fstream.binance.com"
    TEST_REST_URL = "https://testnet.binancefuture.com"
    TEST_WS_URL = "wss://stream.binancefuture.com"

class Defaults:
    EXCHANGE = "BINANCE"
    VENUE = "FUTURES"
    WEB_HOST = "127.0.0.1"
    WEB_PORT = 8000
    LOG_LEVEL = "INFO"
```

------------------------------------------------------------------------

문서 종료
