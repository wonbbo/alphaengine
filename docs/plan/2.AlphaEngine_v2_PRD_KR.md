# AlphaEngine v2 PRD (Product Requirements Document)

생성일: 2026-02-20

------------------------------------------------------------------------

# 1. 제품 개요

## 1.1 제품 정의

AlphaEngine v2는 **Hybrid 방식(WebSocket + REST Polling)**으로 실시간성과 정합성을 모두 확보하고, **Bot과 Web이 SQLite(WAL 모드) 공유 DB**를 통해 자동 매매와 모니터링/설정을 수행하며, **실거래와 Testnet 모드**를 모두 지원하는 안정적인 트레이딩 인프라이다.

## 1.2 제품 목적

1. **전략 개발과 인프라를 완전히 분리**한다.
2. **계좌 상태를 이벤트 기반으로 완전 추적** 가능하게 한다.
3. **자동 매매와 수동 개입이 충돌하지 않는** 구조를 만든다.
4. **시스템 재시작 및 장애 이후에도 완전 복구**를 보장한다.
5. **실시간 체결 감지**로 빠른 전략 반응을 가능하게 한다.
6. **Web을 통한 모니터링 및 설정 변경**을 지원한다.
7. **실거래와 Testnet 간 쉬운 전환**을 지원한다.

------------------------------------------------------------------------

# 2. 범위 (Scope v2)

## 2.1 기능 범위

| 항목 | 범위 |
|------|------|
| 계좌 | 단일 계좌 |
| 심볼 | 단일 심볼 |
| 전략 | 단일 전략 |
| 시장 | Futures 중심 (Spot은 자금 이동 보조) |
| 백테스트 | 미포함 |

## 2.2 거래 모드

| 모드 | 설명 | Binance 엔드포인트 |
|------|------|-------------------|
| **Production** | 실거래 | `fapi.binance.com`, `fstream.binance.com` |
| **Testnet** | 테스트넷 | `testnet.binancefuture.com`, `stream.binancefuture.com` |

## 2.3 데이터 수신 방식

| 방식 | 역할 | 지연 |
|------|------|------|
| **WebSocket** | 실시간 이벤트 수신 (힌트) | 50~100ms |
| **REST Polling** | 정합 보장 (최종 진실) | 30초~1분 |

## 2.4 아키텍처

| 컴포넌트 | 역할 |
|----------|------|
| **Bot** | WebSocket 수신 + REST Reconcile + 전략 실행 + Command 처리 |
| **Web** | 모니터링 대시보드 + 설정 변경 + Command 발행 |
| **SQLite (WAL)** | 공유 DB (Event/Command/Projection/Config) |

## 2.5 운영 환경

| 환경 | OS | 용도 |
|------|-----|------|
| 개발 | Windows | 코드 작성, 로컬 테스트 |
| 운영 | Linux (Ubuntu) | 24/7 Bot + Web 실행 |

------------------------------------------------------------------------

# 3. 시스템 아키텍처 원칙

1. **모든 상태 변경은 Event로 기록**된다.

2. **전략은 거래소 API를 직접 호출하지 않는다.**

3. **UI/Web은 Command를 통해서만 상태를 변경**한다.

4. **모든 Command는 idempotent**하다.

5. **Exchange가 최종 진실이며 Reconciler가 존재**한다.

6. **Projection은 파생물이며 진실이 아니다.**

7. **Event Store만으로 전체 상태 재구성이 가능**해야 한다.

8. **WebSocket은 힌트이며, REST Polling이 최종 정합**을 보장한다.

9. **Bot과 Web은 SQLite WAL 모드로 동시 접근 안전성**을 확보한다.

------------------------------------------------------------------------

# 4. 핵심 기능 요구사항

## 4.1 Hybrid 데이터 수신

### WebSocket User Data Stream
- Binance User Data Stream 연결 (`listenKey` 관리)
- `ACCOUNT_UPDATE`: 잔고/포지션 변경
- `ORDER_TRADE_UPDATE`: 주문/체결 변경
- 연결 끊김 시 자동 재연결

### REST Polling Reconciler
- 30초~1분 간격으로 폴링
- `list_trades()`: 체결 내역
- `list_open_orders()`: 오픈 주문
- `get_position()`: 포지션
- `list_balances()`: 잔고

### Event Merge
- dedup_key로 중복 제거
- WebSocket 먼저 처리, REST가 보완
- 어떤 소스든 같은 Event로 수렴

## 4.2 전략 실행

- 전략은 Decision만 생성한다.
- Orchestrator가 Decision을 검증 후 Command로 변환한다.
- Executor만 거래소 API를 호출한다.
- Decision → Command → Event 흐름이 추적 가능해야 한다.

## 4.3 사용자 개입 (Web)

- 모든 수동 개입은 Command 형태로 처리한다.
- 사용자 명령은 전략보다 우선한다.
- 수동 청산 시 오픈 주문 자동 정리.
- 모든 과정은 이벤트로 기록한다.

### Web에서 가능한 행위
| 행위 | Command Type |
|------|--------------|
| 엔진 일시정지 | PauseEngine |
| 엔진 재개 | ResumeEngine |
| 전체 주문 취소 | CancelAll |
| 수동 청산 | ClosePosition |
| 설정 변경 | UpdateConfig |
| 레버리지 변경 | SetLeverage |

## 4.4 주문 수명주기 관리

- OrderPlaced, OrderUpdated, OrderRejected 이벤트 기록.
- TradeExecuted가 실질적 체결 진실이다.
- exchange_trade_id 기반 dedup 적용.
- 부분체결 즉시 포지션 반영.
- WebSocket에서 실시간 상태 업데이트.

## 4.5 API 실패 및 장애 대응

- 타임아웃 시 즉시 재주문 금지.
- client_order_id로 존재 여부 확인 후 처리.
- 중복 주문 0 보장.
- 장애 상황은 이벤트로 기록하되 Engine은 RUNNING 유지.
- 429 Rate Limit 시 Retry-After 대기 후 재시도.

## 4.6 재시작 복구

부팅 순서:

1. SQLite 연결 (WAL 모드 활성화)
2. Event Store 로드
3. Projection 재구성 (또는 체크포인트에서 이어서)
4. WebSocket 연결
5. REST로 거래소 상태 조회
6. Reconcile 수행
7. 전략 루프 시작

재시작 이후 중복 주문 발생 금지.

## 4.7 정합(Reconciliation)

- 주기적으로 거래소 히스토리 조회 (30초~1분)
- WebSocket 누락 이벤트 보완
- 누락 이벤트만 append (dedup_key로 중복 제거)
- DriftDetectedEvent 기록
- 자동 정정 후 ReconciledEvent 기록

## 4.8 수수료 및 펀딩비 처리

- TradeExecuted, FeeCharged, FundingApplied 이벤트 분리
- Projection에서 순손익 계산
- 거래소 손익과 정합성 유지

## 4.9 리스크 가드

- max_risk_per_trade 검증
- daily_loss_limit 검증
- 위반 시 주문 생성 금지
- RiskGuardRejectedEvent 기록

## 4.10 설정 관리 (v2 신규)

### 설정 저장 방식

| 분류 | 저장 위치 | 내용 |
|------|----------|------|
| **보안 정보** | secrets.yaml (git ignore) | API Key, Secret, JWT Secret, 모드 선택 |
| **런타임 설정** | DB config_store | 전략, 리스크, 심볼 등 |
| **고정 상수** | 하드코딩 (constants.py) | Binance URL, 기본값 |

### secrets.yaml (보안 정보)
```yaml
# config/secrets.yaml (git ignore 필수)
mode: testnet  # production | testnet

production:
  api_key: "xxx"
  api_secret: "xxx"

testnet:
  api_key: "xxx"
  api_secret: "xxx"

web:
  secret_key: "xxx"
```

### config_store 테이블 (런타임 설정)
| 필드 | 설명 |
|------|------|
| key | 설정 키 |
| value_json | 설정 값 (JSON) |
| version | 설정 버전 |
| updated_at | 수정 시각 |
| updated_by | 수정자 (web/bot) |

### DB 설정 예시
```json
{
  "trading": {
    "symbol": "XRPUSDT",
    "account_id": "main"
  },
  "strategy": {
    "name": "sma_cross",
    "timeframe": "5m",
    "params": {"fast": 10, "slow": 20}
  },
  "risk": {
    "max_risk_per_trade": 0.02,
    "daily_loss_limit": 0.05
  },
  "engine": {
    "poll_interval_sec": 30
  },
  "logging": {
    "level": "INFO"
  }
}
```

### 하드코딩 상수 (constants.py)
```python
class BinanceEndpoints:
    PROD_REST_URL = "https://fapi.binance.com"
    PROD_WS_URL = "wss://fstream.binance.com"
    TEST_REST_URL = "https://testnet.binancefuture.com"
    TEST_WS_URL = "wss://stream.binancefuture.com"

class Defaults:
    EXCHANGE = "BINANCE"
    VENUE = "FUTURES"
    WEB_HOST = "127.0.0.1"
    WEB_PORT = 8000
```

### 설정 변경 흐름
1. Web에서 config_store 업데이트
2. Bot이 주기적으로 config_store 조회 (또는 변경 알림)
3. 변경 감지 시 ConfigChanged 이벤트 기록
4. 새 설정 적용

## 4.11 Rate Limit 관리 (v2 신규)

### 응답 헤더 추적
- `X-MBX-USED-WEIGHT-1m`: 현재 분 사용량
- `X-MBX-ORDER-COUNT-1m`: 주문 수

### 백오프 정책
| 사용량 | 동작 |
|--------|------|
| < 1500 | 정상 |
| 1500~2000 | 경고 로그 |
| 2000~2300 | 폴링 간격 증가 |
| > 2300 | 요청 중단, 대기 |
| 429 응답 | Retry-After 대기 |

------------------------------------------------------------------------

# 5. 비기능 요구사항

## 5.1 안정성

| 항목 | 요구사항 |
|------|----------|
| 중복 주문 | 0건 |
| 이벤트 누락 | 0건 |
| 동일 trade_id 중복 기록 | 0건 |
| WebSocket 끊김 시 데이터 손실 | 0건 |

## 5.2 성능

| 항목 | 요구사항 |
|------|----------|
| WebSocket 체결 감지 | < 200ms |
| REST 백업 감지 | < 60초 |
| 재시작 후 복구 시간 | < 30초 |
| 수동 개입 후 정합 수렴 | < 10초 |

## 5.3 운영 환경

| 항목 | 요구사항 |
|------|----------|
| 단일 서버 운영 | 가능 |
| 24시간 무중단 운영 | 가능 |
| Testnet ↔ Production 전환 | 설정만으로 가능 |
| Bot/Web 독립 재시작 | 가능 |

## 5.4 보안

| 항목 | 요구사항 |
|------|----------|
| API Key 관리 | 환경 변수 또는 Secret Manager |
| Web 접근 | HTTPS + 인증 |
| DB 접근 | 내부 네트워크만 |

------------------------------------------------------------------------

# 6. 성공 기준

1. **전략 교체 시 코어 수정 불필요**
2. **Event Store만으로 상태 100% 재구성 가능**
3. **자동/수동 개입 충돌 없음**
4. **거래소 손익과 내부 손익 일치**
5. **WebSocket 끊김 시에도 이벤트 누락 없음**
6. **Testnet에서 충분히 검증 후 Production 전환 가능**
7. **Web에서 실시간 상태 모니터링 가능**
8. **Web에서 설정 변경 즉시 반영**

------------------------------------------------------------------------

문서 종료
