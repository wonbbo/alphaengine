# AlphaEngine v2 TRD --- Database Schema (PostgreSQL)

생성일: 2026-02-20

본 문서는 AlphaEngine v2의 PostgreSQL 데이터베이스 스키마를 TRD 수준으로 고정한다.

------------------------------------------------------------------------

# 1. 설계 원칙

1. **Event Store는 Append-Only**
   - INSERT만, UPDATE/DELETE 금지
   - 모든 상태 변경의 원천

2. **Command Store는 상태 추적**
   - NEW → SENT → ACK/FAILED
   - idempotency_key로 중복 방지

3. **Projection은 파생물**
   - Event로부터 재생성 가능
   - 성능 최적화 목적

4. **Config Store는 버전 관리**
   - Web에서 수정 가능
   - 버전으로 변경 추적

5. **JSONB 활용**
   - payload 저장에 JSONB 사용
   - 필요 시 인덱싱 가능

------------------------------------------------------------------------

# 2. 스키마 개요

```
┌─────────────────────────────────────────────────────────────────────┐
│                      AlphaEngine v2 PostgreSQL                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     Source of Truth                          │   │
│  │                                                              │   │
│  │  ┌──────────────┐          ┌──────────────┐                 │   │
│  │  │ event_store  │          │command_store │                 │   │
│  │  │ (append-only)│          │ (stateful)   │                 │   │
│  │  └──────────────┘          └──────────────┘                 │   │
│  │                                                              │   │
│  │  ┌──────────────────────┐                                   │   │
│  │  │ command_to_exchange  │                                   │   │
│  │  │ (order mapping)      │                                   │   │
│  │  └──────────────────────┘                                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      Projections                             │   │
│  │                                                              │   │
│  │  ┌──────────────────────┐  ┌──────────────────────┐        │   │
│  │  │projection_position   │  │projection_balance    │        │   │
│  │  └──────────────────────┘  └──────────────────────┘        │   │
│  │                                                              │   │
│  │  ┌──────────────────────┐  ┌──────────────────────┐        │   │
│  │  │projection_order_open │  │projection_trade      │        │   │
│  │  └──────────────────────┘  └──────────────────────┘        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      Configuration                           │   │
│  │                                                              │   │
│  │  ┌──────────────────────┐  ┌──────────────────────┐        │   │
│  │  │    config_store      │  │   checkpoint_store   │        │   │
│  │  └──────────────────────┘  └──────────────────────┘        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

------------------------------------------------------------------------

# 3. 테이블 정의

## 3.1 event_store (Source of Truth)

```sql
CREATE TABLE event_store (
    seq              BIGSERIAL PRIMARY KEY,
    event_id         UUID NOT NULL UNIQUE,
    event_type       VARCHAR(64) NOT NULL,
    ts               TIMESTAMPTZ NOT NULL,
    
    correlation_id   UUID NOT NULL,
    causation_id     UUID,
    command_id       UUID,
    source           VARCHAR(32) NOT NULL,  -- WEBSOCKET, REST, BOT, WEB
    
    entity_kind      VARCHAR(32) NOT NULL,  -- ORDER, TRADE, POSITION, etc.
    entity_id        VARCHAR(128) NOT NULL,
    
    scope_exchange   VARCHAR(32) NOT NULL,
    scope_venue      VARCHAR(32) NOT NULL,
    scope_account_id VARCHAR(64) NOT NULL,
    scope_symbol     VARCHAR(32),
    scope_mode       VARCHAR(32) NOT NULL DEFAULT 'PRODUCTION',
    
    dedup_key        VARCHAR(256) NOT NULL,
    payload_json     JSONB NOT NULL,
    
    created_at       TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 중복 방지 (핵심)
CREATE UNIQUE INDEX ux_event_store_dedup_key
ON event_store(dedup_key);

-- 시계열 조회
CREATE INDEX ix_event_store_ts
ON event_store(ts);

-- 엔티티별 조회
CREATE INDEX ix_event_store_entity
ON event_store(entity_kind, entity_id);

-- 이벤트 타입별 조회
CREATE INDEX ix_event_store_type
ON event_store(event_type);

-- correlation 조회
CREATE INDEX ix_event_store_correlation
ON event_store(correlation_id);

-- scope별 조회
CREATE INDEX ix_event_store_scope
ON event_store(scope_exchange, scope_venue, scope_symbol);
```

### 규칙

- INSERT만 허용, UPDATE/DELETE 금지
- dedup_key UNIQUE로 중복 이벤트 방지
- WebSocket과 REST 동시 수신 시 먼저 도착한 것만 저장

------------------------------------------------------------------------

## 3.2 command_store (Command Queue)

```sql
CREATE TABLE command_store (
    seq              BIGSERIAL PRIMARY KEY,
    command_id       UUID NOT NULL UNIQUE,
    command_type     VARCHAR(64) NOT NULL,
    ts               TIMESTAMPTZ NOT NULL,
    
    correlation_id   UUID NOT NULL,
    causation_id     UUID,
    
    actor_kind       VARCHAR(32) NOT NULL,  -- STRATEGY, USER, SYSTEM
    actor_id         VARCHAR(128) NOT NULL, -- strategy:xxx, web:admin, etc.
    
    scope_exchange   VARCHAR(32) NOT NULL,
    scope_venue      VARCHAR(32) NOT NULL,
    scope_account_id VARCHAR(64) NOT NULL,
    scope_symbol     VARCHAR(32),
    scope_mode       VARCHAR(32) NOT NULL DEFAULT 'PRODUCTION',
    
    idempotency_key  VARCHAR(256) NOT NULL,
    status           VARCHAR(32) NOT NULL DEFAULT 'NEW',
    priority         INTEGER NOT NULL DEFAULT 0,
    
    payload_json     JSONB NOT NULL,
    result_json      JSONB,
    last_error       TEXT,
    
    created_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    claimed_at       TIMESTAMPTZ,
    completed_at     TIMESTAMPTZ
);

-- 중복 방지
CREATE UNIQUE INDEX ux_command_store_idempotency_key
ON command_store(idempotency_key);

-- Bot 폴링용 (status + priority + ts)
CREATE INDEX ix_command_store_queue
ON command_store(status, priority DESC, ts)
WHERE status = 'NEW';

-- correlation 조회
CREATE INDEX ix_command_store_correlation
ON command_store(correlation_id);

-- 시계열 조회
CREATE INDEX ix_command_store_ts
ON command_store(ts);
```

### 상태 값

| status | 의미 |
|--------|------|
| NEW | 생성됨, 미처리 |
| SENT | Bot이 claim, 처리 중 |
| ACK | 성공 완료 |
| FAILED | 실패 완료 |

### Bot Claim 쿼리

```sql
-- 트랜잭션 내에서 실행
UPDATE command_store
SET status = 'SENT', claimed_at = NOW(), updated_at = NOW()
WHERE command_id = (
    SELECT command_id FROM command_store
    WHERE status = 'NEW'
    ORDER BY priority DESC, ts
    LIMIT 1
    FOR UPDATE SKIP LOCKED
)
RETURNING *;
```

------------------------------------------------------------------------

## 3.3 command_to_exchange (Order Mapping)

```sql
CREATE TABLE command_to_exchange (
    command_id        UUID NOT NULL UNIQUE,
    client_order_id   VARCHAR(128) NOT NULL UNIQUE,
    exchange_order_id VARCHAR(128),
    
    status            VARCHAR(32),
    last_checked_ts   TIMESTAMPTZ,
    metadata_json     JSONB,
    
    created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    CONSTRAINT fk_command_to_exchange_command
        FOREIGN KEY (command_id) REFERENCES command_store(command_id)
);

CREATE INDEX ix_command_to_exchange_exchange_order
ON command_to_exchange(exchange_order_id)
WHERE exchange_order_id IS NOT NULL;
```

------------------------------------------------------------------------

## 3.4 projection_position (현재 포지션)

```sql
CREATE TABLE projection_position (
    id               BIGSERIAL PRIMARY KEY,
    scope_exchange   VARCHAR(32) NOT NULL,
    scope_venue      VARCHAR(32) NOT NULL,
    scope_account_id VARCHAR(64) NOT NULL,
    scope_symbol     VARCHAR(32) NOT NULL,
    scope_mode       VARCHAR(32) NOT NULL DEFAULT 'PRODUCTION',
    
    side             VARCHAR(16),  -- LONG, SHORT, BOTH
    qty              DECIMAL(30, 10) NOT NULL DEFAULT 0,
    entry_price      DECIMAL(30, 10),
    leverage         INTEGER,
    margin_type      VARCHAR(16),  -- ISOLATED, CROSS
    unrealized_pnl   DECIMAL(30, 10),
    
    last_event_seq   BIGINT NOT NULL,
    updated_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    UNIQUE(scope_exchange, scope_venue, scope_account_id, scope_symbol, scope_mode, side)
);
```

------------------------------------------------------------------------

## 3.5 projection_balance (현재 잔고)

```sql
CREATE TABLE projection_balance (
    id               BIGSERIAL PRIMARY KEY,
    scope_exchange   VARCHAR(32) NOT NULL,
    scope_venue      VARCHAR(32) NOT NULL,
    scope_account_id VARCHAR(64) NOT NULL,
    scope_mode       VARCHAR(32) NOT NULL DEFAULT 'PRODUCTION',
    
    asset            VARCHAR(16) NOT NULL,
    free             DECIMAL(30, 10) NOT NULL DEFAULT 0,
    locked           DECIMAL(30, 10) NOT NULL DEFAULT 0,
    total            DECIMAL(30, 10) GENERATED ALWAYS AS (free + locked) STORED,
    
    last_event_seq   BIGINT NOT NULL,
    updated_at       TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    UNIQUE(scope_exchange, scope_venue, scope_account_id, asset, scope_mode)
);
```

------------------------------------------------------------------------

## 3.6 projection_order_open (오픈 주문)

```sql
CREATE TABLE projection_order_open (
    id                 BIGSERIAL PRIMARY KEY,
    scope_exchange     VARCHAR(32) NOT NULL,
    scope_venue        VARCHAR(32) NOT NULL,
    scope_account_id   VARCHAR(64) NOT NULL,
    scope_symbol       VARCHAR(32) NOT NULL,
    scope_mode         VARCHAR(32) NOT NULL DEFAULT 'PRODUCTION',
    
    exchange_order_id  VARCHAR(128) NOT NULL,
    client_order_id    VARCHAR(128),
    side               VARCHAR(16) NOT NULL,
    order_type         VARCHAR(32) NOT NULL,
    
    original_qty       DECIMAL(30, 10) NOT NULL,
    executed_qty       DECIMAL(30, 10) NOT NULL DEFAULT 0,
    remaining_qty      DECIMAL(30, 10) GENERATED ALWAYS AS (original_qty - executed_qty) STORED,
    
    price              DECIMAL(30, 10),
    stop_price         DECIMAL(30, 10),
    status             VARCHAR(32) NOT NULL,
    
    created_at         TIMESTAMPTZ NOT NULL,
    last_event_seq     BIGINT NOT NULL,
    updated_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    UNIQUE(scope_exchange, scope_venue, exchange_order_id, scope_mode)
);

CREATE INDEX ix_projection_order_open_status
ON projection_order_open(status)
WHERE status IN ('NEW', 'PARTIALLY_FILLED');
```

------------------------------------------------------------------------

## 3.7 projection_trade (체결 기록)

```sql
CREATE TABLE projection_trade (
    id                 BIGSERIAL PRIMARY KEY,
    scope_exchange     VARCHAR(32) NOT NULL,
    scope_venue        VARCHAR(32) NOT NULL,
    scope_account_id   VARCHAR(64) NOT NULL,
    scope_symbol       VARCHAR(32) NOT NULL,
    scope_mode         VARCHAR(32) NOT NULL DEFAULT 'PRODUCTION',
    
    exchange_trade_id  VARCHAR(128) NOT NULL,
    exchange_order_id  VARCHAR(128) NOT NULL,
    client_order_id    VARCHAR(128),
    
    side               VARCHAR(16) NOT NULL,
    qty                DECIMAL(30, 10) NOT NULL,
    price              DECIMAL(30, 10) NOT NULL,
    quote_qty          DECIMAL(30, 10),
    
    commission         DECIMAL(30, 10),
    commission_asset   VARCHAR(16),
    realized_pnl       DECIMAL(30, 10),
    
    trade_ts           TIMESTAMPTZ NOT NULL,
    last_event_seq     BIGINT NOT NULL,
    created_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    UNIQUE(scope_exchange, scope_venue, exchange_trade_id, scope_mode)
);

CREATE INDEX ix_projection_trade_ts
ON projection_trade(trade_ts DESC);

CREATE INDEX ix_projection_trade_order
ON projection_trade(exchange_order_id);
```

------------------------------------------------------------------------

## 3.8 config_store (설정 관리)

```sql
CREATE TABLE config_store (
    id           BIGSERIAL PRIMARY KEY,
    key          VARCHAR(128) NOT NULL UNIQUE,
    value_json   JSONB NOT NULL,
    version      INTEGER NOT NULL DEFAULT 1,
    
    updated_by   VARCHAR(64) NOT NULL,  -- web:admin, bot:system
    created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at   TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 초기 설정 삽입
INSERT INTO config_store (key, value_json, version, updated_by) VALUES
('engine', '{"mode": "RUNNING", "poll_interval_sec": 30}', 1, 'bot:system'),
('strategy', '{"name": null, "params": {}}', 1, 'bot:system'),
('risk', '{"max_risk_per_trade": 0.02, "daily_loss_limit": 0.05}', 1, 'bot:system');
```

------------------------------------------------------------------------

## 3.9 checkpoint_store (체크포인트)

```sql
CREATE TABLE checkpoint_store (
    id               BIGSERIAL PRIMARY KEY,
    checkpoint_type  VARCHAR(64) NOT NULL UNIQUE,
    last_seq         BIGINT NOT NULL DEFAULT 0,
    last_ts          TIMESTAMPTZ,
    metadata_json    JSONB,
    updated_at       TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Projector 체크포인트
INSERT INTO checkpoint_store (checkpoint_type, last_seq) VALUES
('projector', 0),
('reconciler', 0);
```

------------------------------------------------------------------------

# 4. 트랜잭션 규칙

## 4.1 Event Store Append

```sql
BEGIN;
INSERT INTO event_store (...) VALUES (...);
-- ON CONFLICT DO NOTHING (dedup_key 중복 시)
COMMIT;
```

## 4.2 Command Claim

```sql
BEGIN;
UPDATE command_store SET status = 'SENT', claimed_at = NOW()
WHERE command_id = (
    SELECT command_id FROM command_store
    WHERE status = 'NEW'
    ORDER BY priority DESC, ts
    LIMIT 1
    FOR UPDATE SKIP LOCKED
)
RETURNING *;
COMMIT;
```

## 4.3 Projection Update

```sql
BEGIN;
-- Event 적용
UPDATE projection_position SET qty = ..., last_event_seq = ...
WHERE ...;

-- 체크포인트 업데이트
UPDATE checkpoint_store SET last_seq = ..., updated_at = NOW()
WHERE checkpoint_type = 'projector';
COMMIT;
```

------------------------------------------------------------------------

# 5. Web/Bot 접근 규칙

| 테이블 | Bot | Web |
|--------|-----|-----|
| event_store | APPEND | READ only |
| command_store | READ + UPDATE | READ + INSERT |
| command_to_exchange | READ + WRITE | READ only |
| projection_* | READ + WRITE | READ only |
| config_store | READ | READ + WRITE |
| checkpoint_store | READ + WRITE | READ only |

------------------------------------------------------------------------

# 6. 운영 체크리스트

## 시작 전

- [ ] PostgreSQL 서버 실행 중
- [ ] 데이터베이스 생성 (`alphaengine_prod` 또는 `alphaengine_test`)
- [ ] 스키마 적용 (migrations)
- [ ] config_store 초기값 확인

## 정기 작업

- [ ] Event Store 백업 (일간/주간)
- [ ] 오래된 이벤트 아카이빙 (선택)
- [ ] Projection 정합성 검증 (주간)

## 장애 복구

- [ ] Event Store 무결성 확인
- [ ] Projection 재생성 (필요 시)
- [ ] command_store SENT 상태 정리 (고아 처리)

------------------------------------------------------------------------

# 7. 마이그레이션 가이드

Alembic을 사용한 마이그레이션:

```bash
# 마이그레이션 생성
alembic revision --autogenerate -m "add new table"

# 마이그레이션 적용
alembic upgrade head

# 롤백
alembic downgrade -1
```

------------------------------------------------------------------------

문서 종료
