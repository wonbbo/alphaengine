# AlphaEngine v2 이벤트 복구 및 완전 추적 구현 계획

## 문서 개요

| 항목 | 내용 |
|------|------|
| 문서 ID | 13 |
| 작성일 | 2024-02-21 |
| 상태 | 계획 |
| 목적 | Bot 최초 실행 시 과거 데이터 복구 및 운영 중 이벤트 완전 추적 |
| **최대 복구 기간** | **20일** |

## 목차

1. [배경 및 문제 정의](#1-배경-및-문제-정의)
2. [해결 목표](#2-해결-목표)
3. [Binance API 분석](#3-binance-api-분석)
4. [구현 항목](#4-구현-항목)
5. [신규 Event 타입](#5-신규-event-타입)
6. [구현 우선순위](#6-구현-우선순위)
7. [기술 상세](#7-기술-상세)
8. [테스트 계획](#8-테스트-계획)

---

## 1. 배경 및 문제 정의

### 1.1 현재 상황

- Bot이 WebSocket 기반으로 주문/체결/포지션/잔고 이벤트를 실시간 수신
- REST Reconciler가 30초 간격으로 누락 보완
- **문제**: 펀딩비, 내부 이체, Convert 등 WebSocket으로 수신되지 않는 이벤트 존재

### 1.2 해결해야 할 문제

| 문제 | 설명 |
|------|------|
| **초기 자산 미기록** | Bot 최초 실행 시 시작 자산 상태를 알 수 없음 |
| **과거 이벤트 누락** | 첫 실행 전 발생한 거래/펀딩비 등 복구 불가 |
| **운영 중 이벤트 누락** | 펀딩비, 내부 이체 등 WebSocket 미지원 이벤트 |
| **PnL 계산 부정확** | 초기 자산과 누락 이벤트로 인한 수익률 오차 |

### 1.3 목표 범위

- **기본 복구**: 7일 이내 (권장)
- **최대 복구**: **20일** (사용자 요구사항)
- **API 제한**: 30일 (Daily Snapshot API 한계)
- **운영 중 추적**: 모든 자산 변동 이벤트 100% 캡처

> **참고**: 20일 복구는 Daily Snapshot API의 30일 제한 내에 있으므로 완벽한 복구가 가능합니다.

---

## 2. 해결 목표

### 2.1 Bot 최초 실행 시

```
1. 최초 실행 감지
2. 가장 오래된 거래 시점 확인
3. 해당 시점의 Daily Snapshot 조회 → 초기 자산 기록
4. 과거 이벤트 백필 (7일 또는 30일)
5. InitialCapitalEstablished 이벤트 저장
6. 정상 운영 시작
```

### 2.2 운영 중

```
WebSocket (실시간)
├─ ORDER_TRADE_UPDATE → 주문/체결
└─ ACCOUNT_UPDATE → 포지션/잔고

REST Polling (주기적)
├─ Income History (5분) → 펀딩비, 수수료, 이체
├─ Transfer History (30분) → SPOT ↔ FUTURES 이체
├─ Convert History (1시간) → BNB 구매 등
└─ Deposit/Withdraw (저빈도) → 외부 입출금
```

---

## 3. Binance API 분석

### 3.1 초기 자산 조회

| API | Endpoint | Weight | 조회 범위 | 용도 |
|-----|----------|--------|-----------|------|
| **Daily Account Snapshot** | `/sapi/v1/accountSnapshot` | 2400 | **30일** | 초기 자산 |

**중요**: 스냅샷은 **UTC 00:00:00 기준**. 특정 거래 직전 자산을 구하려면 해당 날짜 스냅샷 사용.

### 3.2 과거 데이터 복구용 API

| API | Endpoint | Weight | 조회 범위 | 용도 |
|-----|----------|--------|-----------|------|
| Income History | `/fapi/v1/income` | 100 | 무제한* | 손익/수수료/펀딩비 |
| Transfer History | `/sapi/v1/asset/transfer` | 1 | 6개월 | SPOT↔FUTURES 이체 |
| All Orders | `/fapi/v1/allOrders` | 5 | 7일 (90일 보존) | 주문 이력 |
| User Trades | `/fapi/v1/userTrades` | 5 | 무제한* | 체결 이력 |
| Deposit History | `/sapi/v1/capital/deposit/hisrec` | 1 | 90일 | 외부 입금 |
| Withdraw History | `/sapi/v1/capital/withdraw/history` | 18000 | 90일 | 외부 출금 |
| Convert History | `/sapi/v1/convert/tradeFlow` | 3000 | 30일 | Convert 거래 |
| Dust Log | `/sapi/v1/asset/dribblet` | 1 | 100건 | Dust 전환 |
| Klines | `/fapi/v1/klines` | 5 | 수년 | 과거 환율 |

### 3.3 Income History incomeType 매핑

| incomeType | 설명 | AlphaEngine Event |
|------------|------|-------------------|
| `REALIZED_PNL` | 실현 손익 | TradeExecuted (중복 체크) |
| `FUNDING_FEE` | **펀딩비** | **FundingApplied** |
| `COMMISSION` | 거래 수수료 | FeeCharged (중복 체크) |
| `TRANSFER` | 내부 이체 | InternalTransferCompleted |
| `COMMISSION_REBATE` | 수수료 리베이트 | CommissionRebateReceived (신규) |
| `REFERRAL_KICKBACK` | 추천인 리베이트 | (선택) |
| `WELCOME_BONUS` | 가입 보너스 | (선택) |

---

## 4. 구현 항목

### 4.1 신규 컴포넌트

| 컴포넌트 | 파일 | 역할 |
|----------|------|------|
| **InitialCapitalRecorder** | `bot/recovery/initial_capital.py` | 초기 자산 조회 및 기록 |
| **HistoricalDataRecovery** | `bot/recovery/backfill.py` | 과거 이벤트 백필 |
| **IncomePoller** | `bot/poller/income_poller.py` | Income History 주기적 폴링 |
| **TransferPoller** | `bot/poller/transfer_poller.py` | Transfer History 폴링 |
| **ConvertPoller** | `bot/poller/convert_poller.py` | Convert History 폴링 (선택) |
| **DepositWithdrawPoller** | `bot/poller/deposit_withdraw_poller.py` | 입출금 이력 폴링 |

### 4.2 REST Client 신규 메서드

```python
# adapters/binance/rest_client.py에 추가

async def get_account_snapshot(
    self,
    account_type: str,  # "SPOT", "MARGIN", "FUTURES"
    start_time: datetime | None = None,
    end_time: datetime | None = None,
    limit: int = 7,
) -> dict:
    """Daily Account Snapshot 조회 (Weight: 2400)"""

async def get_income_history(
    self,
    symbol: str | None = None,
    income_type: str | None = None,
    start_time: int | None = None,
    end_time: int | None = None,
    limit: int = 1000,
) -> list[dict]:
    """Income History 조회 (Weight: 100)"""

async def get_transfer_history(
    self,
    transfer_type: str,  # "MAIN_UMFUTURE", "UMFUTURE_MAIN"
    start_time: int | None = None,
    end_time: int | None = None,
    current: int = 1,
    size: int = 100,
) -> dict:
    """Transfer History 조회 (Weight: 1)"""

async def get_convert_history(
    self,
    start_time: int,
    end_time: int,
    limit: int = 100,
) -> dict:
    """Convert Trade History 조회 (Weight: 3000)"""

async def get_historical_klines(
    self,
    symbol: str,
    interval: str,
    start_time: int,
    end_time: int,
    limit: int = 500,
) -> list[dict]:
    """과거 가격 데이터 조회 (환율용)"""
```

### 4.3 EntryBuilder 수정

```python
# core/ledger/entry_builder.py

async def _get_usdt_rate(self, asset: str, ts: datetime) -> Decimal:
    """과거 시점 환율 조회 지원
    
    1. 캐시 확인
    2. Klines API로 과거 가격 조회 (신규)
    3. Fallback: 현재가 또는 기본값
    """
```

### 4.4 Bootstrap 수정

```python
# bot/bootstrap.py

async def start(self) -> None:
    """엔진 시작 (수정)"""
    
    # 최초 실행 확인
    if await self._is_first_run():
        logger.info("최초 실행 감지 - 초기 자산 및 과거 데이터 복구 시작")
        
        # 1. 가장 오래된 거래 시점 확인
        oldest_trade_time = await self._get_oldest_trade_time()
        
        # 2. Daily Snapshot으로 초기 자산 조회
        await self._record_initial_capital(oldest_trade_time)
        
        # 3. 과거 이벤트 백필
        await self._backfill_historical_events()
        
        logger.info("초기화 완료")
    
    # 기존 시작 로직...
```

### 4.5 메인 루프 수정

```python
# bot/bootstrap.py

async def run_main_loop(self, shutdown_event: asyncio.Event) -> None:
    """메인 루프 (수정)"""
    
    while not shutdown_event.is_set():
        # ... 기존 로직 ...
        
        # 6. Income Poller (5분 간격)
        if self.income_poller:
            if await self.income_poller.should_poll():
                await self.income_poller.poll()
        
        # 7. Transfer Poller (30분 간격)
        if self.transfer_poller:
            if await self.transfer_poller.should_poll():
                await self.transfer_poller.poll()
        
        # ... 기타 Poller ...
```

---

## 5. 신규 Event 타입

### 5.1 추가 필요

| Event Type | 용도 | 소스 |
|------------|------|------|
| `InitialCapitalEstablished` | 초기 자산 기록 | Daily Snapshot |
| `ConvertExecuted` | Convert 거래 | Convert History |
| `CommissionRebateReceived` | 수수료 리베이트 | Income History |
| `DustConverted` | Dust 전환 (선택) | Dust Log |

### 5.2 EventTypes 클래스 수정

```python
# core/domain/events.py

class EventTypes:
    # ... 기존 ...
    
    # Initial Capital
    INITIAL_CAPITAL_ESTABLISHED: str = "InitialCapitalEstablished"
    
    # Convert
    CONVERT_EXECUTED: str = "ConvertExecuted"
    
    # Rebate
    COMMISSION_REBATE_RECEIVED: str = "CommissionRebateReceived"
    
    # Dust (선택)
    DUST_CONVERTED: str = "DustConverted"
```

### 5.3 dedup_key 패턴

```python
# 초기 자산
f"initial_capital:{mode}:{snapshot_date}"

# Income (펀딩비, 수수료 등)
f"income:{income_type}:{tran_id}"

# Convert
f"convert:{order_id}"

# Dust
f"dust:{trans_id}"
```

---

## 6. 구현 우선순위

### Phase 1: 핵심 (필수)

| 순서 | 작업 | 중요도 |
|------|------|--------|
| 1 | REST Client: `get_account_snapshot` 구현 | ⭐⭐⭐ |
| 2 | REST Client: `get_income_history` 구현 | ⭐⭐⭐ |
| 3 | `InitialCapitalRecorder` 구현 | ⭐⭐⭐ |
| 4 | `IncomePoller` 구현 (펀딩비, 수수료) | ⭐⭐⭐ |
| 5 | Bootstrap 최초 실행 로직 추가 | ⭐⭐⭐ |
| 6 | `InitialCapitalEstablished` Event 추가 | ⭐⭐⭐ |

### Phase 2: 완성 (권장)

| 순서 | 작업 | 중요도 |
|------|------|--------|
| 7 | REST Client: `get_transfer_history` 구현 | ⭐⭐ |
| 8 | `TransferPoller` 구현 | ⭐⭐ |
| 9 | `HistoricalDataRecovery` 백필 로직 | ⭐⭐ |
| 10 | EntryBuilder 과거 환율 조회 | ⭐⭐ |

### Phase 3: 확장 (선택)

| 순서 | 작업 | 중요도 |
|------|------|--------|
| 11 | REST Client: `get_convert_history` 구현 | ⭐ |
| 12 | `ConvertPoller` 및 `ConvertExecuted` Event | ⭐ |
| 13 | Deposit/Withdraw Poller | ⭐ |
| 14 | Dust Log Poller (저빈도) | ⭐ |

---

## 7. 기술 상세

### 7.1 최초 실행 감지 로직

```python
async def _is_first_run(self) -> bool:
    """최초 실행 여부 확인
    
    config_store의 initial_capital.initialized 플래그로 판단
    """
    initial_capital = await self.config_store.get("initial_capital")
    
    if initial_capital is None:
        return True
    
    return not initial_capital.get("initialized", False)
```

### 7.2 초기 자산 기록 흐름

```
1. Income History에서 가장 오래된 거래 시점 조회
   └─ /fapi/v1/income?limit=1 (가장 오래된 것부터)
   
2. 해당 날짜의 Daily Snapshot 조회
   └─ SPOT Snapshot (UTC 0시 기준)
   └─ FUTURES Snapshot
   
3. InitialCapitalEstablished 이벤트 생성
   └─ payload: {
        "spot_usdt": "100.00",
        "futures_usdt": "400.00",
        "total_usdt": "500.00",
        "snapshot_date": "2024-01-15",
        "method": "daily_snapshot",
        "confidence": "exact"
      }
      
4. config_store에 저장
   └─ key: "initial_capital"
   └─ value: {
        "USDT": "500.00",
        "SPOT_USDT": "100.00",
        "FUTURES_USDT": "400.00",
        "epoch_date": "2024-01-15",
        "initialized": true,
        "recorded_at": "2024-01-20T12:00:00Z"
      }
```

### 7.3 Income Poller 동작

```python
class IncomePoller:
    """Income History 폴링
    
    5분마다 실행하여 펀딩비, 수수료, 이체 등 이벤트 생성
    """
    
    POLL_INTERVAL = 300  # 5분
    
    async def poll(self) -> int:
        """Income 조회 및 이벤트 생성"""
        
        # 마지막 폴링 시간 이후 데이터 조회
        income_list = await self.rest_client.get_income_history(
            start_time=self._last_poll_time_ms,
            limit=1000,
        )
        
        event_count = 0
        
        for income in income_list:
            income_type = income["incomeType"]
            
            # REALIZED_PNL, COMMISSION은 WebSocket에서 이미 처리됨
            # dedup_key로 중복 방지
            
            if income_type == "FUNDING_FEE":
                event = self._create_funding_event(income)
            elif income_type == "TRANSFER":
                event = self._create_transfer_event(income)
            elif income_type == "COMMISSION_REBATE":
                event = self._create_rebate_event(income)
            else:
                continue
            
            saved = await self.event_store.append(event)
            if saved:
                event_count += 1
        
        self._last_poll_time_ms = int(datetime.now(timezone.utc).timestamp() * 1000)
        return event_count
```

### 7.4 Rate Limit 예산

| 폴링 대상 | 간격 | 시간당 Weight |
|-----------|------|---------------|
| Income History | 5분 | 1200 |
| Transfer History | 30분 | 2 |
| Convert History | 1시간 | 3000 |
| Deposit History | 6시간 | 0.17 |
| Withdraw History | 24시간 | 750 |

**시간당 총: ~4952 Weight** (1200/분 제한 대비 여유)

### 7.5 이벤트 순서와 복식부기

**복식부기는 순서에 안전함**:
- 각 entry의 차대변 균형은 독립적
- journal_line에서 언제든 정확한 잔액 재계산 가능
- ts 필드로 원본 시점 보존

**Projection 보정**:
- 주기적으로 account_balance 재계산 권장
- `LedgerStore.rebuild_all_balances()` 메서드 활용

### 7.6 과거 환율 조회

```python
async def _get_historical_price(
    self,
    symbol: str,  # "BNBUSDT"
    timestamp: datetime,
) -> Decimal:
    """과거 특정 시점의 가격 조회
    
    Klines API로 해당 시점의 1분봉 close 가격 반환
    """
    ts_ms = int(timestamp.timestamp() * 1000)
    
    klines = await self.rest_client.get_klines(
        symbol=symbol,
        interval="1m",
        start_time=ts_ms - 60000,
        end_time=ts_ms + 60000,
        limit=3,
    )
    
    if klines:
        return Decimal(klines[0]["close"])
    
    # Fallback
    return await self._get_current_price(symbol)
```

---

## 8. 테스트 계획

### 8.1 단위 테스트

| 테스트 | 파일 |
|--------|------|
| REST Client 신규 메서드 | `tests/unit/adapters/binance/test_rest_client.py` |
| InitialCapitalRecorder | `tests/unit/bot/recovery/test_initial_capital.py` |
| IncomePoller | `tests/unit/bot/poller/test_income_poller.py` |
| Income → Event 변환 | `tests/unit/bot/poller/test_income_mapper.py` |

### 8.2 통합 테스트

| 테스트 | 파일 |
|--------|------|
| 최초 실행 시나리오 | `tests/integration/test_first_run.py` |
| 과거 데이터 백필 | `tests/integration/test_backfill.py` |
| Poller 통합 | `tests/integration/test_pollers.py` |

### 8.3 E2E 테스트

| 테스트 | 파일 |
|--------|------|
| Testnet 초기화 시나리오 | `tests/e2e/scenarios/test_10_first_run.py` |
| 펀딩비 수신 확인 | `tests/e2e/scenarios/test_11_funding_fee.py` |

---

## 부록: 디렉토리 구조

```
bot/
├── recovery/                    # 신규 디렉토리
│   ├── __init__.py
│   ├── initial_capital.py       # 초기 자산 기록
│   └── backfill.py              # 과거 데이터 백필
├── poller/                      # 신규 디렉토리
│   ├── __init__.py
│   ├── base.py                  # Poller 베이스 클래스
│   ├── income_poller.py         # Income History 폴링
│   ├── transfer_poller.py       # Transfer History 폴링
│   ├── convert_poller.py        # Convert History 폴링 (선택)
│   └── deposit_withdraw_poller.py  # 입출금 폴링
├── reconciler/                  # 기존
├── websocket/                   # 기존
└── bootstrap.py                 # 수정
```

---

## 참고 문서

- [docs/binance/daily_account_snapshot.md](../binance/daily_account_snapshot.md) - Daily Snapshot API 상세
- [docs/binance/spot_api.md](../binance/spot_api.md) - SPOT API 상세
- [docs/binance/futures_api.md](../binance/futures_api.md) - FUTURES API 상세
- [docs/plan/12.AlphaEngine_v2_EventTypes_Reference_KR.md](./12.AlphaEngine_v2_EventTypes_Reference_KR.md) - Event 타입 레퍼런스

---

## 변경 이력

| 날짜 | 내용 |
|------|------|
| 2024-02-21 | 최초 작성 |
