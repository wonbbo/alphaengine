# AlphaEngine v2 헌법

생성일: 2026-02-20

------------------------------------------------------------------------

# 1. 핵심 정의 (Core Statement)

AlphaEngine v2는 **WebSocket 실시간 이벤트와 REST Polling 정합을 결합한 Hybrid 방식**으로, 전략 교체가 자유롭고, 모든 계좌 변경을 이벤트로 기록하며, **Bot과 Web이 SQLite(WAL 모드) 공유 DB**를 통해 자동 매매와 모니터링/설정을 수행하고, 재시작 시 모든 것이 100% 복구되며, **실거래와 Testnet 모드를 지원**하는 안정적인 트레이딩 인프라이다.

------------------------------------------------------------------------

# 2. 절대 변경 불가 원칙 (Non-Negotiable Design Rules)

1. **모든 상태 변경은 반드시 Event로 기록된다.**
   - 계좌, 포지션, 잔고, 주문의 모든 변화는 Event Store에 기록된다.

2. **전략은 거래소 API를 직접 호출하지 않는다.**
   - 전략 → Decision → Command → Executor → Exchange 흐름을 따른다.

3. **UI/Web은 Command를 통해서만 상태를 변경한다.**
   - DB 직접 수정 금지 (config_store 제외).
   - 모든 행위는 Command로 발행하고 Bot이 처리한다.

4. **모든 Command는 반드시 idempotent해야 한다.**
   - 동일 Command 재실행 시 결과가 동일해야 한다.
   - idempotency_key로 중복 실행을 방지한다.

5. **Exchange가 최종 진실이며 Reconciler가 반드시 존재한다.**
   - 내부 상태와 거래소 상태가 다르면 거래소가 옳다.
   - Reconciler가 주기적으로 정합을 수행한다.

6. **시스템은 재시작 시 완전 복구가 가능해야 한다.**
   - Event Store만으로 모든 상태를 재구성할 수 있어야 한다.
   - 재시작 후 수동 개입이 필요 없어야 한다.

7. **Projection은 파생물이며, 진실(Source of Truth)이 아니다.**
   - Projection은 Event Store에서 언제든 재생성 가능해야 한다.
   - Projection 손상 시 Event를 재생하여 복구한다.

8. **WebSocket은 힌트이며, REST Polling이 최종 정합을 보장한다.**
   - WebSocket으로 빠른 반응을 얻는다.
   - WebSocket 누락/끊김 시 REST가 보완한다.
   - 두 소스의 이벤트는 dedup_key로 병합된다.

9. **Bot과 Web은 SQLite(WAL 모드)를 공유하며, 동시 접근 안전성을 보장한다.**
   - Bot: Event/Command/Projection 쓰기 (Primary Writer)
   - Web: Command 발행 + Config 쓰기 + 읽기
   - WAL 모드로 다중 Reader + 단일 Writer 지원

10. **실거래와 Testnet은 설정만으로 전환 가능해야 한다.**
    - 코드 수정 없이 환경 변수로 모드 전환
    - 각 모드별 별도 DB 사용 권장

------------------------------------------------------------------------

# 3. 시스템 범위 (Scope v2)

## 계좌 범위
- **멀티계좌 지원**: 지원하지 않는다 (단일 계좌 전용)

## 심볼 범위
- **멀티심볼 지원**: 지원하지 않는다 (단일 심볼 전용)

## 전략 범위
- **멀티전략 동시 실행**: 지원하지 않는다 (단일 전략 전용)

## 시장 범위
- **Spot 포함**: 포함한다. 단, Futures로 자금을 전달하기 위한 보조 거래만 수행한다.
- **실제 수익 창출 거래는 Futures에서만 수행한다.**

## 거래 모드
- **실거래 모드 (Production)**: Binance Futures 실계좌
- **테스트넷 모드 (Testnet)**: Binance Futures Testnet

## 백테스트 범위
- 백테스트는 AlphaEngine에 포함하지 않는다.
- 별도의 소프트웨어에서 수행한다.

## 운영 환경
- **개발 환경**: Windows
- **운영 환경**: Linux (Ubuntu/Debian 권장)

------------------------------------------------------------------------

# 4. 아키텍처적 의미

위 범위 정의에 따라:

1. **엔진 복잡도**는 의도적으로 낮게 유지한다. (Single Account / Single Symbol)

2. **동시성 모델**은 Bot 단일 프로세스 + Web 단일 프로세스로 단순화한다.

3. **전략 실행 파이프라인**은 선형 구조로 설계한다.

4. **포트폴리오 수준 리스크 관리**나 교차 심볼 노출 관리는 v2에서 고려하지 않는다.

5. **백테스트 엔진**은 코어 책임에서 제외한다.

6. **WebSocket + REST Hybrid**로 실시간성과 안정성을 모두 확보한다.

7. **SQLite(WAL 모드)**를 사용하여 Bot/Web 동시 접근을 안전하게 처리한다.

8. **설정 파일(secrets.yaml) 기반**으로 실거래/Testnet 전환을 용이하게 한다.

------------------------------------------------------------------------

# 5. 안정성 요구사항

다음 조건은 항상 만족해야 한다:

1. **Event Store만으로 전체 계좌 상태를 재구성할 수 있어야 한다.**

2. **거래소 이벤트가 중복 수신되어도 안전하게 무시되어야 한다.**
   - WebSocket과 REST 모두에서 동일 이벤트 수신 시 dedup_key로 중복 제거

3. **엔진 재시작 시 수동 복구가 필요 없어야 한다.**
   - WebSocket 재연결 + REST Reconcile로 자동 복구

4. **전략을 제거해도 시스템 안정성이 깨지지 않아야 한다.**

5. **WebSocket 연결 끊김 시에도 데이터 누락이 없어야 한다.**
   - REST Reconciler가 백업으로 모든 이벤트 수집

6. **Bot과 Web 동시 DB 접근 시 데이터 정합성이 유지되어야 한다.**
   - SQLite WAL 모드로 동시 읽기 지원, Bot이 Primary Writer

7. **Rate Limit 초과 시 자동 백오프로 복구되어야 한다.**
   - 429 응답 시 Retry-After 대기 후 재시도

------------------------------------------------------------------------

# 6. 기술 스택

| 구성요소 | 기술 |
|----------|------|
| **언어** | Python 3.11+ |
| **Bot** | asyncio 기반 (WebSocket + REST) |
| **Web** | FastAPI + uvicorn |
| **DB** | SQLite 3 (WAL 모드) |
| **ORM** | SQLAlchemy 2.0 (aiosqlite) |
| **WebSocket** | websockets / aiohttp |
| **REST Client** | httpx (async) |
| **프로세스 관리** | systemd |
| **Reverse Proxy** | nginx |
| **컨테이너 (선택)** | Docker + docker-compose |

------------------------------------------------------------------------

# 7. 디렉토리 구조 (권장)

```
alphaengine-v2/
├── bot/                    # Bot 프로세스
│   ├── __main__.py         # 진입점
│   ├── bootstrap.py        # 메인 루프
│   ├── websocket/          # WebSocket 리스너
│   ├── reconciler/         # REST Reconciler
│   ├── executor/           # Command 실행
│   ├── projector/          # Projection 업데이트
│   └── strategy/           # 전략 로더/러너
│
├── web/                    # Web 프로세스
│   ├── __main__.py         # 진입점
│   ├── app.py              # FastAPI 앱
│   ├── routes/             # API 라우트
│   ├── templates/          # HTML 템플릿 (선택)
│   └── static/             # 정적 파일 (선택)
│
├── core/                   # 공통 코어
│   ├── domain/             # Event, Command, Types
│   ├── storage/            # Repository 인터페이스
│   ├── config/             # 설정 로더
│   └── constants.py        # 하드코딩 상수 (URL 등)
│
├── adapters/               # 외부 연동
│   ├── binance/            # Binance 어댑터
│   │   ├── ws_client.py    # WebSocket 클라이언트
│   │   ├── rest_client.py  # REST 클라이언트
│   │   └── models.py       # DTO
│   └── db/                 # SQLite 어댑터
│
├── strategies/             # 전략 플러그인
│   ├── base.py             # 전략 인터페이스
│   └── examples/           # 예제 전략
│
├── config/                 # 설정 파일
│   ├── secrets.yaml.example  # 보안 설정 예시
│   └── secrets.yaml        # 실제 보안 설정 (git ignore)
│
├── data/                   # 데이터 파일
│   ├── alphaengine_prod.db   # Production DB
│   └── alphaengine_test.db   # Testnet DB
│
├── deploy/                 # 배포 설정
│   ├── systemd/            # systemd 서비스 파일
│   ├── nginx/              # nginx 설정
│   └── docker/             # Docker 파일 (선택)
│
├── tests/                  # 테스트
│
├── pyproject.toml          # 의존성 관리
└── README.md
```

------------------------------------------------------------------------

문서 종료
