# AlphaEngine v2 TRD --- Event Model (Hybrid WebSocket + REST)

생성일: 2026-02-20

본 문서는 AlphaEngine v2의 이벤트 모델을 TRD 수준으로 확정한다.

## 범위

- 단일 계좌 / 단일 심볼 / 단일 전략
- Futures 중심
- Spot 거래 포함 (자금 이동 보조)
- **Hybrid 방식: WebSocket (실시간) + REST Polling (정합)**
- 실거래/Testnet 듀얼 모드

------------------------------------------------------------------------

# 1. 공통 Event Envelope

모든 이벤트는 아래 필드를 포함한다.

```json
{
  "event_id": "uuid",
  "type": "TradeExecuted",
  "ts": "2026-02-20T00:00:01Z",
  "correlation_id": "uuid",
  "causation_id": "uuid-or-null",
  "command_id": "uuid-or-null",
  "source": "WEBSOCKET|REST|BOT|WEB",
  "entity": {
    "kind": "ORDER|TRADE|POSITION|BALANCE|TRANSFER|ENGINE|CONFIG",
    "id": "entity-id"
  },
  "scope": {
    "exchange": "BINANCE",
    "venue": "FUTURES|SPOT",
    "account_id": "acc-001",
    "symbol": "XRPUSDT",
    "mode": "PRODUCTION|TESTNET"
  },
  "dedup_key": "string",
  "payload": {}
}
```

### v2 신규 필드

| 필드 | 설명 |
|------|------|
| `source` | 이벤트 출처 (WEBSOCKET, REST, BOT, WEB) |
| `scope.mode` | 거래 모드 (PRODUCTION, TESTNET) |

------------------------------------------------------------------------

# 2. Event Type 목록

## 2.1 Engine / Control

| Event Type | entity.kind | source | 설명 |
|------------|-------------|--------|------|
| EngineStarted | ENGINE | BOT | 엔진 부팅 완료 |
| EngineStopped | ENGINE | BOT | 정상 종료 |
| EnginePaused | ENGINE | BOT/WEB | 수동 일시정지 |
| EngineResumed | ENGINE | BOT/WEB | 재개 |
| EngineModeChanged | ENGINE | BOT/WEB | 모드 변경 (RUNNING/SAFE/PAUSED) |
| ManualOverrideExecuted | ENGINE | BOT | 수동 개입 실행 완료 |
| RiskGuardRejected | ENGINE | BOT | 리스크 정책 위반으로 명령 거절 |
| ConfigChanged | CONFIG | WEB | 설정 변경 (v2 신규) |

## 2.2 WebSocket Connection (v2 신규)

| Event Type | entity.kind | source | 설명 |
|------------|-------------|--------|------|
| WebSocketConnected | ENGINE | BOT | WebSocket 연결 성공 |
| WebSocketDisconnected | ENGINE | BOT | WebSocket 연결 끊김 |
| WebSocketReconnected | ENGINE | BOT | WebSocket 재연결 성공 |

## 2.3 Orders / Trades (SPOT & FUTURES 공통)

| Event Type | entity.kind | source | 설명 |
|------------|-------------|--------|------|
| OrderPlaced | ORDER | WEBSOCKET/REST/BOT | 주문 생성 성공 |
| OrderRejected | ORDER | WEBSOCKET/REST/BOT | 주문 거절 |
| OrderCancelled | ORDER | WEBSOCKET/REST/BOT | 주문 취소 완료 |
| OrderUpdated | ORDER | WEBSOCKET/REST | 주문 상태 변경 |
| TradeExecuted | TRADE | WEBSOCKET/REST | 체결 단위 이벤트 (핵심) |

### OrderUpdated.status 값

- NEW
- PARTIALLY_FILLED
- FILLED
- CANCELLED
- REJECTED
- EXPIRED

------------------------------------------------------------------------

## 2.4 Position / Balance / Fee

| Event Type | entity.kind | source | 설명 |
|------------|-------------|--------|------|
| PositionChanged | POSITION | WEBSOCKET/REST | 포지션 수량/평단 변경 |
| BalanceChanged | BALANCE | WEBSOCKET/REST | 잔고 변경 |
| FeeCharged | BALANCE | REST | 수수료 발생 |
| FundingApplied | POSITION | REST | 펀딩비 적용 (Futures) |

------------------------------------------------------------------------

## 2.5 Internal Transfer (Futures ↔ Spot)

| Event Type | entity.kind | source | 설명 |
|------------|-------------|--------|------|
| InternalTransferRequested | TRANSFER | BOT | 내부이체 요청 |
| InternalTransferCompleted | TRANSFER | REST | 내부이체 완료 |
| InternalTransferFailed | TRANSFER | REST | 내부이체 실패 |

------------------------------------------------------------------------

## 2.6 External Deposit / Withdraw

| Event Type | entity.kind | source | 설명 |
|------------|-------------|--------|------|
| DepositDetected | BALANCE | REST | 외부 입금 감지 |
| WithdrawRequested | BALANCE | BOT | 출금 요청 생성 |
| WithdrawCompleted | BALANCE | REST | 출금 완료 |
| WithdrawFailed | BALANCE | REST | 출금 실패 |

------------------------------------------------------------------------

## 2.7 Reconciliation / Audit

| Event Type | entity.kind | source | 설명 |
|------------|-------------|--------|------|
| DriftDetected | ENGINE | BOT | 내부 상태와 거래소 상태 불일치 탐지 |
| ReconciliationPerformed | ENGINE | BOT | 리컨실 수행 완료 |
| QuarantineStarted | ENGINE | BOT | 격리 모드 시작 |
| QuarantineCompleted | ENGINE | BOT | 격리 모드 종료 |

------------------------------------------------------------------------

# 3. Dedup Key 규칙

| Event Type | Primary dedup_key | 비고 |
|------------|-------------------|------|
| TradeExecuted | `{exchange}:{venue}:{symbol}:trade:{exchange_trade_id}` | 가장 중요 |
| Order* | `{exchange}:{venue}:{symbol}:order:{exchange_order_id}` 또는 `client_order_id` | |
| PositionChanged | `{exchange}:{venue}:{symbol}:position:{side}:{qty}:{avg_price}` | 스냅샷 기반 |
| BalanceChanged | `{exchange}:{venue}:{account}:{asset}:{free}:{locked}` | 스냅샷 기반 |
| DepositDetected | `{exchange}:deposit:{deposit_id}` 또는 `tx_id` | |
| WithdrawCompleted | `{exchange}:withdraw:{withdraw_id}` 또는 `tx_id` | |
| InternalTransferCompleted | `{exchange}:transfer:{transfer_id}` | |
| FundingApplied | `{exchange}:{symbol}:funding:{funding_ts}` | |
| FeeCharged | `{exchange}:{venue}:{symbol}:fee:{trade_id}` | |
| DriftDetected | `{exchange}:{venue}:{symbol}:drift:{drift_kind}:{time_bucket}` | 스팸 방지 |
| ReconciliationPerformed | `{exchange}:{venue}:{symbol}:recon:{drift_event_seq}` | |
| WebSocket* | `{exchange}:ws:{event_type}:{ts_ms}` | 연결 이벤트 |
| ConfigChanged | `config:{key}:{version}` | |

### Dedup 처리

- WebSocket과 REST 모두에서 같은 이벤트 발생 가능
- dedup_key가 같으면 먼저 도착한 것만 저장
- SQLite UNIQUE INDEX로 강제

------------------------------------------------------------------------

# 4. Event 생성 책임

| Event 그룹 | 생성 주체 | 설명 |
|------------|-----------|------|
| Engine 관련 | Bot | 상태 변경 시 |
| WebSocket Connection | Bot | 연결 상태 변경 시 |
| OrderPlaced/Rejected | Bot (Executor) | API 응답 시 |
| Order/Trade (실시간) | Bot (WebSocket Listener) | WebSocket 메시지 수신 시 |
| Order/Trade (정합) | Bot (Reconciler) | REST 조회 후 |
| Deposit/Withdraw | Bot (Reconciler) | REST 조회 후 |
| InternalTransfer | Bot | 요청: Executor / 완료: Reconciler |
| Drift/Reconcile | Bot (Reconciler) | 정합 수행 시 |
| Config | Web | 설정 변경 시 |

------------------------------------------------------------------------

# 5. WebSocket Event Mapping (Binance)

## 5.1 ORDER_TRADE_UPDATE → Events

```json
{
  "e": "ORDER_TRADE_UPDATE",
  "o": {
    "s": "XRPUSDT",
    "c": "ae-xxx",
    "S": "BUY",
    "o": "MARKET",
    "X": "FILLED",
    "l": "100",
    "L": "0.5123",
    "t": 123456789
  }
}
```

매핑:
- `X` (status) 변경 → `OrderUpdated`
- `l` (lastFilledQty) > 0 → `TradeExecuted`

## 5.2 ACCOUNT_UPDATE → Events

```json
{
  "e": "ACCOUNT_UPDATE",
  "a": {
    "B": [{"a": "USDT", "wb": "1000", "cw": "900"}],
    "P": [{"s": "XRPUSDT", "pa": "100", "ep": "0.5"}]
  }
}
```

매핑:
- `B` (balances) 변경 → `BalanceChanged`
- `P` (positions) 변경 → `PositionChanged`

------------------------------------------------------------------------

# 6. Hybrid 수신 규칙

## 6.1 WebSocket 우선

1. WebSocket에서 이벤트 수신
2. 즉시 Event Store에 append (dedup_key 사용)
3. Projection 업데이트
4. 전략에 ctx 제공

## 6.2 REST 보완

1. 30초~1분 간격으로 REST 조회
2. Event 생성 시도 (동일 dedup_key)
3. 이미 존재하면 무시 (중복)
4. 새 이벤트면 append

## 6.3 WebSocket 끊김 시

1. WebSocketDisconnected 이벤트 기록
2. REST Polling 간격 단축 (예: 5초)
3. 재연결 성공 시 WebSocketReconnected 이벤트
4. REST로 누락 이벤트 수집

------------------------------------------------------------------------

# 7. 검증 체크리스트

1. Event Store만으로 상태 재구성 가능
2. 동일 trade_id 중복 반영 0건
3. WebSocket + REST 동시 수신 시 dedup 정상 동작
4. WebSocket 끊김 후 REST로 복구 정상
5. 주문 타임아웃 후 조회-결정 프로토콜 정상 동작
6. 입출금 UUID/txid로 완전 추적 가능
7. 내부이체 Requested → Completed/Failed 수렴

------------------------------------------------------------------------

문서 종료
