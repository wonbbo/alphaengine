# AlphaEngine v2 -- Immediate Execution Roadmap (Phase 0 ~ Phase 3)

Generated: 2026-02-20

------------------------------------------------------------------------

# 🎯 Purpose

이 문서는 AlphaEngine v2를 올바르게 구조화하기 위해 필요한 **즉각적인 다음 단계**를 정의한다.

목표:
> 전략 교체가 자유롭고, 계좌 추적이 완벽하며, 자동/수동 행위가 충돌하지 않는 트레이딩 인프라를 구축한다.
> **Hybrid 방식(WebSocket + REST Polling)**으로 실시간성과 정합성을 모두 확보한다.

------------------------------------------------------------------------

# 🔄 v1 대비 주요 변경사항

| 항목 | v1 (기존) | v2 (신규) |
|------|-----------|-----------|
| 데이터 수신 | REST Polling only | **Hybrid (WebSocket + REST Polling)** |
| 실시간성 | 1초 지연 | 50~100ms 지연 |
| 운영 환경 | Windows 개발용 | **Windows 개발 + Linux 운영** |
| 거래 모드 | 실거래만 | **실거래 + Testnet** |
| 아키텍처 | Bot only | **Bot + Web 모니터링** |
| DB 접근 | Bot만 Write | **Bot + Web 모두 Write** |
| Rate Limit | 고려 부족 | **헤더 추적 + 백오프** |

------------------------------------------------------------------------

# 🚦 Current Position

**Phase 0 (설계 확정)** 단계에 있다.

⚠️ 아직 프로덕션 코드를 작성하지 않는다.

------------------------------------------------------------------------

# PHASE 0 --- Philosophy Freeze (1-2일)

## Task 0.1 --- Core Statement 작성

AlphaEngine v2를 한 문장으로 정의:

> "AlphaEngine v2는 WebSocket 실시간 이벤트와 REST Polling 정합을 결합한 Hybrid 방식으로, 전략 교체가 자유롭고, 모든 계좌 변경을 이벤트로 기록하며, Bot과 Web이 SQLite(WAL 모드) 공유 DB를 통해 자동 매매와 모니터링을 수행하는 안정적인 트레이딩 인프라이다."

필수 포함 사항:
- Hybrid 방식 (WebSocket + REST)
- 전략 교체 자유
- 이벤트 기반 계좌 추적
- Bot + Web 아키텍처
- 실거래/Testnet 듀얼 모드

------------------------------------------------------------------------

## Task 0.2 --- Non-Negotiable Rules 정의

## 절대 변경 불가 원칙

1. 모든 상태 변경은 반드시 Event로 기록된다.
2. 전략은 거래소 API를 직접 호출하지 않는다.
3. UI/Web은 Command를 통해서만 상태를 변경한다.
4. 모든 Command는 반드시 idempotent해야 한다.
5. Exchange가 최종 진실이며 Reconciler가 반드시 존재한다.
6. 시스템은 재시작 시 완전 복구가 가능해야 한다.
7. Projection은 파생물이며, 진실(Source of Truth)이 아니다.
8. **WebSocket은 힌트이며, REST Polling이 최종 정합을 보장한다.**
9. **Bot과 Web 모두 같은 SQLite DB에 접근하며, WAL 모드로 동시 접근 안전성을 보장한다.**

------------------------------------------------------------------------

# PHASE 1 --- PRD (Product Definition)

## Task 1.1 --- System Scope 정의

### 계좌/심볼/전략 범위
- 단일 계좌 지원
- 단일 심볼 지원
- 단일 전략 지원

### 시장 범위
- Futures 중심 (수익 창출)
- Spot 포함 (자금 이동 보조)

### 거래 모드
- **실거래 모드**: Binance Production (`fapi.binance.com`)
- **테스트넷 모드**: Binance Testnet (`testnet.binancefuture.com`)

### 백테스트
- AlphaEngine에 포함하지 않음 (별도 소프트웨어)

### 운영 환경
- **개발**: Windows
- **운영**: Linux (systemd 서비스)

### 아키텍처
- **Bot**: 자동 트레이딩 담당 (WebSocket + REST + 전략 실행)
- **Web**: 모니터링 + 설정 변경 담당 (FastAPI/Flask)
- **DB**: SQLite WAL (Bot + Web 공유)

------------------------------------------------------------------------

## Task 1.2 --- Core Use Cases 정의

### UC-01: 전략이 진입 신호 생성
- Trigger: WebSocket에서 체결/가격 이벤트 수신
- 행위: 전략이 ctx 분석 → Command 발행 → Executor 실행
- 결과: OrderPlaced/TradeExecuted 이벤트 기록

### UC-02: 사용자가 Web에서 수동 청산
- Trigger: Web UI에서 "청산" 버튼 클릭
- 행위: Web이 Command 발행 → Bot이 처리
- 결과: 포지션 청산, 이벤트 기록

### UC-03: 거래소 부분 체결
- Trigger: WebSocket ACCOUNT_UPDATE/ORDER_TRADE_UPDATE
- 행위: 즉시 이벤트 생성 → Projection 반영
- 결과: 포지션/잔고 업데이트

### UC-04: 거래소 API 일시 실패
- Trigger: HTTP 5xx 또는 타임아웃
- 행위: 백오프 후 재시도 → 실패 시 DriftDetected
- 결과: 다음 Reconciler tick에서 복구

### UC-05: Bot 재시작 중 열린 포지션
- Trigger: Bot 프로세스 종료 후 재시작
- 행위: Event Store 로드 → WebSocket 재연결 → Reconcile
- 결과: 상태 100% 복구, 중복 주문 없음

### UC-06: 거래소와 내부 상태 불일치
- Trigger: Reconciler가 drift 감지
- 행위: DriftDetected 이벤트 → 자동/수동 복구
- 결과: ReconciliationPerformed 이벤트

### UC-07: 사용자가 Web에서 설정 변경
- Trigger: Web UI에서 설정 변경 (전략 파라미터 등)
- 행위: Command 발행 → Bot이 수신 → 설정 적용
- 결과: ConfigChanged 이벤트 기록

### UC-08: WebSocket 연결 끊김
- Trigger: 네트워크 장애 또는 서버 문제
- 행위: 자동 재연결 시도 → REST Polling으로 누락 보완
- 결과: 이벤트 누락 없음

------------------------------------------------------------------------

## Task 1.3 --- Success Criteria 정의

- 중복 주문: 0건
- 이벤트 누락: 0건 (WebSocket 끊김 시에도)
- 재시작 후 완전 복구
- 전략 교체 시 코어 수정 불필요
- 체결 감지 지연: < 200ms (WebSocket 정상 시)
- 체결 감지 지연: < 30초 (WebSocket 끊김 시, REST 백업)
- Bot/Web 동시 접근 시 데이터 정합성 유지

------------------------------------------------------------------------

# PHASE 2 --- Domain & Contract Definition

## Task 2.1 --- Event List 확정

### Engine / Control
- EngineStarted
- EngineStopped
- EnginePaused
- EngineResumed
- EngineModeChanged
- ManualOverrideExecuted
- RiskGuardRejected
- ConfigChanged (v2 신규)

### Orders / Trades
- OrderPlaced
- OrderRejected
- OrderCancelled
- OrderUpdated
- TradeExecuted

### Position / Balance / Fee
- PositionChanged
- BalanceChanged
- FeeCharged
- FundingApplied

### Internal Transfer
- InternalTransferRequested
- InternalTransferCompleted
- InternalTransferFailed

### External Deposit / Withdraw
- DepositDetected
- WithdrawRequested
- WithdrawCompleted
- WithdrawFailed

### Reconciliation / Audit
- DriftDetected
- ReconciliationPerformed
- QuarantineStarted
- QuarantineCompleted

### WebSocket (v2 신규)
- WebSocketConnected
- WebSocketDisconnected
- WebSocketReconnected

------------------------------------------------------------------------

## Task 2.2 --- Command List 확정

### Engine / Control
- PauseEngine
- ResumeEngine
- SetEngineMode
- CancelAll
- RunReconcile
- RebuildProjection
- UpdateConfig (v2 신규)

### Trading
- PlaceOrder
- CancelOrder
- ClosePosition
- SetLeverage

### Transfers
- InternalTransfer
- Withdraw

------------------------------------------------------------------------

## Task 2.3 --- State Machines 정의

### OrderState
```
NEW → SUBMITTED → ACKNOWLEDGED → PARTIALLY_FILLED → FILLED
                              ↘                   ↗
                               → CANCELLED/REJECTED/EXPIRED
```

### PositionState
```
FLAT → ENTERING → OPEN → EXITING → FLAT
```

### EngineState
```
BOOTING → RUNNING → PAUSED → SAFE
             ↑________↓
```

### CommandState
```
NEW → SENT → ACK
          ↘ FAILED
```

### WebSocketState (v2 신규)
```
DISCONNECTED → CONNECTING → CONNECTED → RECONNECTING
                    ↑____________↓
```

------------------------------------------------------------------------

## Task 2.4 --- Idempotency Keys 확정

- exchange_trade_id: 체결 고유 ID
- exchange_order_id: 주문 고유 ID
- client_order_id: 클라이언트 주문 ID (`ae-{command_id}`)
- deposit_tx_id: 입금 트랜잭션 ID
- withdraw_tx_id: 출금 트랜잭션 ID
- transfer_id: 내부이체 ID
- config_version: 설정 버전 (v2 신규)

------------------------------------------------------------------------

# PHASE 3 --- Architecture Definition (v2 신규)

## Task 3.1 --- Hybrid Architecture 정의

### 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Hybrid Architecture                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Binance Exchange                                                    │
│  ┌──────────┐    ┌──────────┐                                       │
│  │ WebSocket│    │  REST    │                                       │
│  │  Stream  │    │   API    │                                       │
│  └────┬─────┘    └────┬─────┘                                       │
│       │               │                                              │
│       │ 실시간        │ 정합                                         │
│       │ (50~100ms)    │ (30초 간격)                                  │
│       ↓               ↓                                              │
│  ┌────────────────────────────────────────┐                         │
│  │              Bot Process               │                         │
│  │  ┌──────────┐  ┌──────────┐           │                         │
│  │  │WebSocket │  │Reconciler│           │                         │
│  │  │ Listener │  │ (REST)   │           │                         │
│  │  └────┬─────┘  └────┬─────┘           │                         │
│  │       │             │                  │                         │
│  │       └──────┬──────┘                  │                         │
│  │              ↓                         │                         │
│  │       ┌──────────┐                     │                         │
│  │       │ Event    │ dedup_key로         │                         │
│  │       │ Merger   │ 중복 제거           │                         │
│  │       └────┬─────┘                     │                         │
│  │            ↓                           │                         │
│  │       ┌──────────┐  ┌──────────┐      │                         │
│  │       │ Event    │  │ Command  │      │                         │
│  │       │ Store    │  │ Store    │      │                         │
│  │       └────┬─────┘  └────┬─────┘      │                         │
│  │            ↓             ↓             │                         │
│  │       ┌──────────────────────┐        │                         │
│  │       │     SQLite (WAL)      │        │                         │
│  │       └──────────┬───────────┘        │                         │
│  └──────────────────│────────────────────┘                         │
│                     │                                               │
│                     │ 공유 DB                                       │
│                     ↓                                               │
│  ┌──────────────────────────────────────┐                         │
│  │             Web Process              │                         │
│  │  ┌──────────┐  ┌──────────┐         │                         │
│  │  │ Dashboard│  │ Settings │         │                         │
│  │  │  (Read)  │  │  (Write) │         │                         │
│  │  └──────────┘  └──────────┘         │                         │
│  └──────────────────────────────────────┘                         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### WebSocket 역할
- 실시간 체결/포지션/잔고 변경 감지
- 빠른 반응 (50~100ms)
- 연결 끊김 시 자동 재연결

### REST Polling 역할
- WebSocket 누락 보완
- 최종 정합 보장
- 30초~1분 간격

### Merge 규칙
- dedup_key로 중복 제거
- WebSocket 이벤트 먼저 처리
- REST가 나중에 같은 이벤트 발견 시 무시

------------------------------------------------------------------------

## Task 3.2 --- Bot + Web 아키텍처 정의

### 프로세스 구조

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Linux Server                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────────────────────────────┐                           │
│  │           Bot Process                │                           │
│  │  (systemd: alphaengine-bot.service)  │                           │
│  │                                      │                           │
│  │  - WebSocket Listener                │                           │
│  │  - REST Reconciler                   │                           │
│  │  - Strategy Runner                   │                           │
│  │  - Command Executor                  │                           │
│  │  - Projector                         │                           │
│  │                                      │                           │
│  │  Permissions: READ + WRITE           │                           │
│  └──────────────────┬───────────────────┘                           │
│                     │                                                │
│                     │ TCP/IP                                         │
│                     ↓                                                │
│  ┌──────────────────────────────────────┐                           │
│  │           SQLite (WAL 모드)          │                           │
│  │                                      │                           │
│  │  - event_store                       │                           │
│  │  - command_store                     │                           │
│  │  - projection_*                      │                           │
│  │  - config_store (v2 신규)            │                           │
│  │                                      │                           │
│  └──────────────────┬───────────────────┘                           │
│                     │                                                │
│                     │ TCP/IP                                         │
│                     ↓                                                │
│  ┌──────────────────────────────────────┐                           │
│  │           Web Process                │                           │
│  │  (systemd: alphaengine-web.service)  │                           │
│  │                                      │                           │
│  │  - FastAPI + uvicorn                 │                           │
│  │  - Dashboard (읽기)                  │                           │
│  │  - Settings (쓰기)                   │                           │
│  │  - Command 발행 (쓰기)               │                           │
│  │                                      │                           │
│  │  Permissions: READ + WRITE           │                           │
│  └──────────────────────────────────────┘                           │
│                     │                                                │
│                     │ reverse proxy                                  │
│                     ↓                                                │
│  ┌──────────────────────────────────────┐                           │
│  │           Nginx                      │                           │
│  │  (HTTPS termination)                 │                           │
│  └──────────────────────────────────────┘                           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### DB 접근 규칙

| 테이블 | Bot | Web |
|--------|-----|-----|
| event_store | READ + APPEND | READ only |
| command_store | READ + WRITE | READ + INSERT |
| projection_* | READ + WRITE | READ only |
| config_store | READ | READ + WRITE |

### Command 발행 흐름 (Web → Bot)

```
1. Web이 command_store에 INSERT (status=NEW)
2. Bot이 주기적으로 NEW 상태 Command 조회 (claim)
3. Bot이 Command 실행
4. Bot이 status=ACK/FAILED 업데이트
5. Bot이 Event 생성
```

------------------------------------------------------------------------

## Task 3.3 --- 실거래/Testnet 듀얼 모드 정의

### 설정 파일 (secrets.yaml)

```yaml
# config/secrets.yaml (git ignore 필수)
mode: testnet  # production | testnet

production:
  api_key: "your_production_api_key"
  api_secret: "your_production_api_secret"

testnet:
  api_key: "your_testnet_api_key"
  api_secret: "your_testnet_api_secret"

web:
  secret_key: "your_jwt_secret_key"
```

### 하드코딩 상수 (constants.py)

```python
# core/constants.py
class BinanceEndpoints:
    """Binance API 엔드포인트 (고정값)"""
    PROD_REST_URL = "https://fapi.binance.com"
    PROD_WS_URL = "wss://fstream.binance.com"
    TEST_REST_URL = "https://testnet.binancefuture.com"
    TEST_WS_URL = "wss://stream.binancefuture.com"
```

### 설정 로더

```python
# core/config/loader.py
import yaml
from core.constants import BinanceEndpoints

class TradingMode(Enum):
    PRODUCTION = "production"
    TESTNET = "testnet"

def load_secrets(path: str = "config/secrets.yaml") -> dict:
    with open(path) as f:
        return yaml.safe_load(f)

def get_config(secrets: dict) -> ExchangeConfig:
    mode = TradingMode(secrets["mode"])
    creds = secrets[mode.value]
    
    if mode == TradingMode.PRODUCTION:
        return ExchangeConfig(
            ws_url=BinanceEndpoints.PROD_WS_URL,
            rest_url=BinanceEndpoints.PROD_REST_URL,
            api_key=creds["api_key"],
            api_secret=creds["api_secret"],
        )
    else:
        return ExchangeConfig(
            ws_url=BinanceEndpoints.TEST_WS_URL,
            rest_url=BinanceEndpoints.TEST_REST_URL,
            api_key=creds["api_key"],
            api_secret=creds["api_secret"],
        )
```

### DB 분리 (권장)

```
production: data/alphaengine_prod.db (SQLite)
testnet:    data/alphaengine_test.db (SQLite)
```

------------------------------------------------------------------------

## Task 3.4 --- Rate Limit 관리 정의

### 응답 헤더 추적

```python
class RateLimitTracker:
    used_weight_1m: int = 0
    order_count_1m: int = 0
    retry_after: int = 0
    
    def update_from_headers(self, headers: dict):
        self.used_weight_1m = int(headers.get("X-MBX-USED-WEIGHT-1m", 0))
        self.order_count_1m = int(headers.get("X-MBX-ORDER-COUNT-1m", 0))
        self.retry_after = int(headers.get("Retry-After", 0))
```

### 429 백오프

```python
def request_with_backoff(self, method, url, params, max_retries=3):
    for attempt in range(max_retries):
        try:
            response = self.session.request(method, url, params=params)
            self.rate_tracker.update_from_headers(response.headers)
            return response.json()
        except HTTPError as e:
            if e.status_code == 429:
                wait_time = int(e.headers.get("Retry-After", 30))
                time.sleep(wait_time)
                continue
            raise
```

### Weight 임계값

```python
WEIGHT_THRESHOLD_WARN = 1500   # 경고
WEIGHT_THRESHOLD_SLOW = 2000   # 속도 저하
WEIGHT_THRESHOLD_STOP = 2300   # 요청 중단
```

------------------------------------------------------------------------

# 🔎 Validation Checklist

코드 작성 전 확인:

- [ ] Event Store만으로 전체 상태 재구성 가능한가?
- [ ] WebSocket 끊김 시 REST로 누락 복구 가능한가?
- [ ] 동일 trade_id 중복 반영이 방지되는가?
- [ ] 엔진 재시작 시 수동 복구 없이 복원되는가?
- [ ] 전략 제거 시 시스템 안정성이 유지되는가?
- [ ] Bot과 Web 동시 DB 접근 시 정합성이 유지되는가?
- [ ] Testnet과 Production 전환이 설정만으로 가능한가?

------------------------------------------------------------------------

# 🚀 Implementation Phases (Foundation First 방식)

## 개발 철학

**"다시 들여다보지 않아도 되는" 튼튼한 기반을 먼저 구축한 후 순차 개발**

1. 독립 모듈을 테스트 포함하여 완성
2. 시나리오별 E2E 검증 (Testnet)
3. 스켈레톤 구축
4. 비즈니스 로직 순차 개발

------------------------------------------------------------------------

## Dev-Phase 0: 핵심 유틸리티 (독립, 외부 의존성 0)

**목표**: 순수 Python, 외부 호출 없음, 100% 단위 테스트 가능

| 순서 | 모듈 | 설명 | 테스트 |
|------|------|------|--------|
| 0.1 | `core/constants.py` | 하드코딩 상수 (URL, 기본값) | ✅ |
| 0.2 | `core/types.py` | Enum, TypedDict, Dataclass 정의 | ✅ |
| 0.3 | `core/config/loader.py` | secrets.yaml 로더 | ✅ |
| 0.4 | `core/config/config_store.py` | DB 설정 로더/저장 (인터페이스) | ✅ |
| 0.5 | `core/domain/events.py` | Event Envelope, Event Types | ✅ |
| 0.6 | `core/domain/commands.py` | Command Envelope, Command Types | ✅ |
| 0.7 | `core/utils/dedup.py` | dedup_key 생성 유틸리티 | ✅ |
| 0.8 | `core/utils/idempotency.py` | client_order_id 생성 | ✅ |

**완료 기준**: 모든 모듈 pytest 통과, 외부 호출 없음

------------------------------------------------------------------------

## Dev-Phase 1: 외부 서비스 어댑터 (인터페이스 + 구현 + Mock)

**목표**: Protocol/ABC 정의 → 실제 구현 → Mock 구현 → 단위 테스트

### 1.1 인터페이스 정의 (Protocol)

```python
# adapters/interfaces.py
class IExchangeRestClient(Protocol):
    async def get_account_balance(self) -> list[Balance]: ...
    async def get_position(self, symbol: str) -> Position: ...
    async def place_order(self, order: OrderRequest) -> OrderResult: ...
    async def cancel_order(self, symbol: str, order_id: str) -> bool: ...
    async def get_open_orders(self, symbol: str) -> list[Order]: ...
    async def get_trades(self, symbol: str, limit: int) -> list[Trade]: ...

class IExchangeWsClient(Protocol):
    async def connect(self) -> None: ...
    async def disconnect(self) -> None: ...
    async def subscribe_user_data(self, callback: Callable) -> None: ...

class INotifier(Protocol):
    async def send(self, message: str, level: str) -> None: ...
```

### 1.2 구현 순서

| 순서 | 모듈 | 설명 | 테스트 |
|------|------|------|--------|
| 1.1 | `adapters/interfaces.py` | Protocol 정의 | - |
| 1.2 | `adapters/binance/rest_client.py` | Binance REST 구현 | ✅ Mock |
| 1.3 | `adapters/binance/ws_client.py` | Binance WebSocket 구현 | ✅ Mock |
| 1.4 | `adapters/binance/models.py` | Binance DTO 변환 | ✅ |
| 1.5 | `adapters/mock/exchange_client.py` | Mock 거래소 클라이언트 | ✅ |
| 1.6 | `adapters/slack/notifier.py` | Slack 알림 (선택) | ✅ Mock |
| 1.7 | `adapters/db/sqlite_adapter.py` | SQLite 연결/WAL 설정 | ✅ |

**완료 기준**: 각 어댑터 단위 테스트 통과, Mock으로 교체 가능

------------------------------------------------------------------------

## Dev-Phase 2: 시나리오별 E2E 검증 (Testnet)

**목표**: 실제 Binance Testnet에서 핵심 시나리오 동작 확인

### 2.1 연결 시나리오

| 순서 | 시나리오 | 검증 항목 |
|------|----------|----------|
| 2.1.1 | REST 연결 | secrets.yaml 로드 → REST 연결 → 잔고 조회 |
| 2.1.2 | WebSocket 연결 | listenKey 발급 → WS 연결 → 이벤트 수신 |
| 2.1.3 | WebSocket 재연결 | 연결 끊김 → 자동 재연결 → 이벤트 복구 |

### 2.2 자금 시나리오

| 순서 | 시나리오 | 검증 항목 |
|------|----------|----------|
| 2.2.1 | 잔고 조회 | REST로 USDT 잔고 확인 |
| 2.2.2 | 입금 감지 | (Testnet 제한적) BalanceChanged 이벤트 |
| 2.2.3 | 내부 이체 | Spot ↔ Futures 이체 (가능한 경우) |

### 2.3 매매 시나리오

| 순서 | 시나리오 | 검증 항목 |
|------|----------|----------|
| 2.3.1 | 시장가 매수 | PlaceOrder → OrderPlaced → TradeExecuted |
| 2.3.2 | 시장가 매도 | 포지션 청산 → PositionChanged |
| 2.3.3 | 지정가 주문 | LIMIT 주문 → 대기 → 체결/취소 |
| 2.3.4 | 주문 취소 | CancelOrder → OrderCancelled |
| 2.3.5 | 부분 체결 | 대량 주문 → 부분 체결 → 잔량 확인 |

### 2.4 리스크 시나리오

| 순서 | 시나리오 | 검증 항목 |
|------|----------|----------|
| 2.4.1 | 손절 (Stop Loss) | STOP_MARKET 주문 → 트리거 → 청산 |
| 2.4.2 | 익절 (Take Profit) | TAKE_PROFIT_MARKET → 트리거 → 청산 |
| 2.4.3 | 레버리지 변경 | SetLeverage → 확인 |

### 2.5 장애 시나리오

| 순서 | 시나리오 | 검증 항목 |
|------|----------|----------|
| 2.5.1 | API 타임아웃 | 타임아웃 → client_order_id로 조회 → 복구 |
| 2.5.2 | Rate Limit | 429 응답 → Retry-After 대기 → 재시도 |
| 2.5.3 | WebSocket 끊김 | 끊김 → REST 폴링 → 누락 이벤트 복구 |

**완료 기준**: 모든 시나리오 Testnet에서 성공, 로그 확인

------------------------------------------------------------------------

## Dev-Phase 3: Thin Slice (최소 동작 흐름)

**목표**: 전체 흐름을 관통하는 최소 기능 동작 확인

```
secrets.yaml 로드
    ↓
Binance REST 연결
    ↓
잔고 조회
    ↓
SQLite DB 저장 (event_store)
    ↓
콘솔/로그 출력
```

| 순서 | 작업 | 설명 |
|------|------|------|
| 3.1 | DB 스키마 생성 | event_store, command_store, config_store |
| 3.2 | EventStore 구현 | append, get_by_id, get_after |
| 3.3 | Thin Slice 스크립트 | 위 흐름 동작 확인 |

**완료 기준**: 단일 스크립트로 잔고 조회 → DB 저장 → 조회 성공

------------------------------------------------------------------------

## Dev-Phase 4: 스켈레톤 구축

**목표**: Bot/Web 기본 구조, 메인 루프, 라우트 정의

| 순서 | 모듈 | 설명 |
|------|------|------|
| 4.1 | `bot/__main__.py` | Bot 진입점 |
| 4.2 | `bot/bootstrap.py` | 설정 로드, 의존성 주입, 메인 루프 |
| 4.3 | `web/__main__.py` | Web 진입점 |
| 4.4 | `web/app.py` | FastAPI 앱, 라우트 등록 |
| 4.5 | `web/routes/` | API 라우트 스켈레톤 |

**완료 기준**: Bot/Web 각각 시작 → 정상 종료

------------------------------------------------------------------------

## Dev-Phase 5: 코어 로직 순차 개발

| 순서 | 모듈 | 설명 | 의존성 |
|------|------|------|--------|
| 5.1 | `bot/websocket/listener.py` | WebSocket 이벤트 수신 | Phase 1 어댑터 |
| 5.2 | `bot/reconciler/reconciler.py` | REST 정합 검사 | Phase 1 어댑터 |
| 5.3 | `bot/executor/executor.py` | Command 실행 | Phase 1 어댑터 |
| 5.4 | `bot/projector/projector.py` | Projection 업데이트 | EventStore |
| 5.5 | `core/domain/state_machines.py` | 상태 머신 | Phase 0 타입 |
| 5.6 | `bot/risk/guard.py` | 리스크 가드 | Projection |
| 5.7 | `strategies/base.py` | 전략 인터페이스 | - |
| 5.8 | `strategies/examples/sma_cross.py` | 예제 전략 | 전략 인터페이스 |

------------------------------------------------------------------------

## Dev-Phase 6: 통합 및 운영 준비

| 순서 | 작업 | 설명 |
|------|------|------|
| 6.1 | 통합 테스트 | 전체 흐름 E2E 테스트 |
| 6.2 | Web UI | 대시보드, 설정 화면 |
| 6.3 | 배포 설정 | systemd, nginx |
| 6.4 | 모니터링 | 로깅, 알림 |
| 6.5 | Production 전환 | Testnet → Production |

------------------------------------------------------------------------

# 📌 Phase별 체크리스트

## Dev-Phase 0 완료 조건
- [ ] 모든 core 모듈 pytest 100% 통과
- [ ] 외부 네트워크 호출 없음
- [ ] 타입 힌트 완전

## Dev-Phase 1 완료 조건
- [ ] 모든 어댑터 Protocol 준수
- [ ] Mock 어댑터로 교체 가능
- [ ] 단위 테스트 통과

## Dev-Phase 2 완료 조건
- [ ] Testnet에서 모든 시나리오 성공
- [ ] 시나리오별 로그/결과 문서화
- [ ] 장애 시나리오 복구 확인

## Dev-Phase 3 완료 조건
- [ ] Thin Slice 동작 확인
- [ ] DB CRUD 정상

## Dev-Phase 4 완료 조건
- [ ] Bot/Web 시작/종료 정상
- [ ] 설정 로드 정상

## Dev-Phase 5 완료 조건
- [ ] 전체 이벤트 흐름 동작
- [ ] 전략 교체 가능
- [ ] 리스크 가드 동작

## Dev-Phase 6 완료 조건
- [ ] Testnet 24시간 무중단 운영
- [ ] Production 전환 준비 완료

------------------------------------------------------------------------

문서 종료
